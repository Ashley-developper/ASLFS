/* ASL FLIGHT SIMULATOR will be no longer supported from January 1, 2026.*/
/* Copyright 2025 Ashley .inc, Zhanyi Zhou. All rights reserved*/
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASL flight simulator</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; user-select: none; }
        
        /* ä»ªè¡¨ç›˜å¸ƒå±€ */
        #hud-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column; justify-content: space-between;
            padding: 25px; box-sizing: border-box; z-index: 10;
        }

        .hud-top-left { display: flex; gap: 20px; }
        
        .instrument {
            background: rgba(10, 20, 30, 0.75); 
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-left: 4px solid #00aaff;
            backdrop-filter: blur(8px); 
            padding: 10px 18px; 
            color: #eee; 
            min-width: 100px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        
        .label { font-size: 10px; color: #88ccff; font-weight: 600; letter-spacing: 1px; margin-bottom: 4px; display:block; text-transform: uppercase;}
        .value { font-size: 26px; font-weight: 700; font-family: 'Consolas', monospace; letter-spacing: -1px; }
        .unit { font-size: 12px; color: #888; margin-left: 4px; font-weight: 400;}

        /* æ²¹é—¨æ¨æ† */
        #throttle-wrapper {
            position: absolute; left: 30px; bottom: 120px; width: 12px; height: 240px;
            background: rgba(0,0,0,0.6); border: 1px solid #555; border-radius: 8px;
            padding: 2px;
        }
        #throttle-fill {
            position: absolute; bottom: 2px; left: 2px; width: 12px; height: 0%;
            background: linear-gradient(to top, #4caf50, #ffeb3b, #ff5722);
            border-radius: 4px; transition: height 0.1s;
        }
        #throttle-label {
            position: absolute; left: 50px; bottom: 120px; color: #fff; font-size: 12px; font-weight: bold;
            transform: rotate(-90deg); transform-origin: left bottom; opacity: 0.7;
        }

        /* è­¦å‘Šä¿¡æ¯ */
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.2; }
        }

        #center-warning {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #ff3333; font-size: 24px; font-weight: bold; border: 2px solid #ff3333;
            padding: 10px 30px; background: rgba(0,0,0,0.7); display: none;
            /* ä¼˜åŒ–ï¼šæ–°å¢é—ªçƒæ•ˆæœ */
            animation: blink 0.5s step-end infinite;
        }

        /* å¯åŠ¨ç”»é¢ */
#splash {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    /* ğŸ¨ å¤©è“è‰²ç«‹ä½“èƒŒæ™¯ */
    background: linear-gradient(135deg, #0093E9 0%, #80D0C7 100%);
    z-index: 999; 
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    color: white;
    /* æŠ•å½±æ•ˆæœ */
    text-shadow: 0 4px 8px rgba(0, 0, 0, 0.4); 
}

h1 { 
    font-size: 32px; 
    margin: 0; 
    font-weight: 400; 
    letter-spacing: 5px; 
    text-transform: uppercase;
    color: #fff;
    /* æŠ•å½±æ•ˆæœ */
    text-shadow: 0 4px 8px rgba(0, 0, 0, 0.4); 
}

/* æ ‡é¢˜æ ·å¼ï¼šChoose Your Plane */
#plane-chooser-title {
    font-size: 20px; 
    margin-bottom: 20px; 
    font-weight: 600; 
    color: #f0f0f0; 
    letter-spacing: 3px;
}

/* 3D æ¨¡å‹å®¹å™¨æ ·å¼ */
#plane-model-container {
    width: 600px;
    height: 300px;
    margin: 20px 0 10px; /* è°ƒæ•´ margin */
    /* ç°ä»£è¾¹æ¡†å’ŒèƒŒæ™¯ */
    background: rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    overflow: hidden;
    position: relative;
}

/* æ¨¡å‹åˆ‡æ¢æŒ‰é’®æ ·å¼ */
.model-nav-button {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0, 0, 0, 0.4);
    border: none;
    color: white;
    padding: 10px;
    cursor: pointer;
    font-size: 24px;
    z-index: 10;
    transition: background 0.2s;
}

.model-nav-button:hover {
    background: rgba(0, 0, 0, 0.7);
}

#prev-plane { left: 10px; border-radius: 50%; }
#next-plane { right: 10px; border-radius: 50%; }

/* é£æœºå‚æ•°å±•ç¤ºåŒºæ ·å¼ (æ–°å¢) */
#plane-info-display {
    text-align: center;
    margin-top: 15px;
    padding: 15px 30px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    min-width: 450px;
}

.plane-title {
    font-size: 18px;
    font-weight: 700;
    color: #fff;
    margin-bottom: 10px;
    letter-spacing: 1px;
    text-transform: uppercase;
}

.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 5px 20px;
    font-size: 13px;
    color: #c0e0f0;
}

.stat-value {
    font-family: 'Consolas', monospace;
    font-weight: bold;
    color: #80D0C7;
    margin-left: 5px;
}


/* æŒ‰é’®å’Œæ§åˆ¶ç½‘æ ¼æ ·å¼æ›´æ–° */
.controls-grid {
    display: grid; grid-template-columns: auto auto; gap: 10px 20px; 
    margin-top: 20px;
    text-align: left; 
    background: rgba(0,0,0,0.3); /* æ·±è‰²é€æ˜èƒŒæ™¯ */
    padding: 20px; 
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.2);
    font-size: 14px;
}

.key-box { 
    font-family: 'Consolas', monospace; 
    color: #80D0C7; /* åŒ¹é…ä¸»é¢˜è‰² */
    font-weight: bold; 
    margin-right: 8px;
    background: rgba(255, 255, 255, 0.15);
    padding: 2px 6px;
    border-radius: 4px;
    border: 1px solid #80D0C7;
}

button#start-button {
    margin-top: 40px; 
    padding: 14px 50px; 
    font-size: 16px; 
    font-weight: 700; 
    border: none; /* ç§»é™¤è¾¹æ¡† */
    background: #0093E9; 
    color: #fff; 
    cursor: pointer; 
    letter-spacing: 2px;
    transition: all 0.3s; 
    text-transform: uppercase;
    border-radius: 30px; /* åœ†è§’æŒ‰é’® */
    box-shadow: 0 6px 20px rgba(0, 147, 233, 0.6);
}
button#start-button:hover { 
    background: #80D0C7; 
    color: #000; 
    box-shadow: 0 6px 25px rgba(128, 208, 199, 0.8); 
}
/* ä¼˜åŒ–ï¼šæŒ‰é’®æŒ‰ä¸‹æ•ˆæœ */
button#start-button:active {
    transform: translateY(2px);
    box-shadow: 0 3px 10px rgba(0, 147, 233, 0.6);
}

        /* ğŸš€ æ ·å¼ï¼šç”»è´¨é€‰æ‹©é¢æ¿ */
#quality-selector {
    position: absolute; 
    right: 25px; 
    bottom: 25px; 
    z-index: 10;
    pointer-events: all; /* ç¡®ä¿å¯ä»¥ç‚¹å‡» */
    background: rgba(10, 20, 30, 0.75); 
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-right: 4px solid #00aaff; /* åŒ¹é…ä»ªè¡¨ç›˜æ ·å¼ */
    backdrop-filter: blur(8px); 
    padding: 10px 18px; 
    color: #eee; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.5);
}

#quality-selector .label {
    display: block;
    font-size: 10px; 
    color: #88ccff; 
    font-weight: 600; 
    letter-spacing: 1px; 
    margin-bottom: 8px;
    text-transform: uppercase;
}

.button-group button {
    /* é‡ç½®é»˜è®¤æŒ‰é’®æ ·å¼ */
    all: unset; 
    cursor: pointer;
    font-size: 14px;
    padding: 4px 10px;
    margin-left: 5px;
    border: 1px solid #00aaff;
    color: #00aaff;
    background-color: rgba(0, 170, 255, 0.1);
    transition: all 0.2s;
}

.button-group button:first-child {
    margin-left: 0;
}

/* é€‰ä¸­çŠ¶æ€ */
.button-group button.active,
.button-group button:hover {
    background-color: #00aaff;
    color: #1a2a3a;
    font-weight: bold;
}

/* ğŸš€ æ–°å¢ï¼šLoading ç•Œé¢æ ·å¼ */
#loading-screen {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.95);
    z-index: 1000; /* æ¯” splash é«˜ */
    display: none; /* é»˜è®¤éšè—ï¼Œåœ¨ startGame ä¸­æ˜¾ç¤º */
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 20px;
}

#loading-progress-bar {
    width: 300px;
    height: 10px;
    margin-top: 20px;
    background: #555;
    border-radius: 5px;
    overflow: hidden;
}

#loading-progress-fill {
    height: 100%;
    width: 0%;
    background: #00aaff;
    transition: width 0.3s;
}
    /*END SUPPORT*/
        #notice-modal {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.85);
    z-index: 2000; /* ç¡®ä¿åœ¨æœ€é¡¶å±‚ï¼Œé«˜äº splash */
    display: flex; align-items: center; justify-content: center;
    backdrop-filter: blur(5px);
}

#notice-content {
    width: 600px;
    background: rgba(20, 30, 40, 0.95);
    border: 1px solid rgba(128, 208, 199, 0.3);
    border-left: 5px solid #ff3333; /* çº¢è‰²è­¦å‘Šæ¡ */
    border-radius: 12px;
    padding: 30px;
    color: #eee;
    box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
    font-family: 'Segoe UI', Roboto, sans-serif;
    position: relative;
    animation: fadeIn 0.5s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
}

#notice-header {
    font-size: 22px;
    font-weight: 700;
    color: #ff5555;
    margin-bottom: 20px;
    letter-spacing: 1px;
    text-transform: uppercase;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding-bottom: 10px;
}

.notice-text {
    font-size: 15px;
    line-height: 1.6;
    color: #ccc;
    margin-bottom: 15px;
}

.notice-highlight {
    color: #80D0C7;
    font-weight: bold;
}

#notice-link {
    display: inline-block;
    margin: 10px 0 20px;
    color: #0093E9;
    text-decoration: none;
    font-weight: bold;
    border-bottom: 1px dashed #0093E9;
    transition: all 0.2s;
}
#notice-link:hover { color: #80D0C7; border-color: #80D0C7; }

#notice-footer {
    font-size: 12px;
    color: #666;
    margin-top: 20px;
    text-align: right;
    font-style: italic;
}

#notice-close-btn {
    display: block;
    width: 100%;
    margin-top: 25px;
    padding: 12px;
    background: linear-gradient(135deg, #0093E9 0%, #80D0C7 100%);
    border: none;
    border-radius: 6px;
    color: white;
    font-weight: bold;
    font-size: 16px;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 2px;
    transition: transform 0.1s, box-shadow 0.2s;
}
#notice-close-btn:hover {
    box-shadow: 0 0 15px rgba(0, 147, 233, 0.5);
}
#notice-close-btn:active { transform: scale(0.98); }
        /*END SUPPORT*/
    </style>
</head>
<body>
    /*END SUPPORT*/
    <div id="notice-modal">
    <div id="notice-content">
        <div id="notice-header">âš ï¸ End of Support Notice</div>
        
        <div class="notice-text">
            <strong style="color: #fff;">ASL Flight Simulator will no longer be supported from January 5, 2026.</strong>
        </div>

        <div class="notice-text">
            What you are playing now is the first complex game that <span class="notice-highlight">Ashley</span> has ever made. It is the beginner of our game development journey. Ashley had spent hours for this game. We used THREE.js, self-designed physics and modern UI.
        </div>

        <div class="notice-text">
            Sadly, ASL Flight Simulator hasn't achieved our game mission's goal: to be a popular game on CrazyGames. Its final score is 5/15. That's why Ashley decides to end its support.
        </div>

        <div class="notice-text">
            ASL Flight Simulator is the base of all our games. We should not forget it -- the first ever, real, game.
        </div>
        
        <div class="notice-text" style="background: rgba(0,147,233,0.1); padding: 10px; border-radius: 4px; border-left: 3px solid #0093E9;">
            This is not the end. Ashley is always trying something new. Go visit our main website from the link below and check our progress:<br>
            <a id="notice-link" href="https://Ashley-developper.github.io" target="_blank">ğŸ”— Ashley-developper.github.io</a>
        </div>

        <div id="notice-footer">
            Writed by Zhanyi Zhou, who made this game.<br>Ashley is the name of the brand.
        </div>

        <button id="notice-close-btn" onclick="closeNotice()">I Understand</button>
    </div>
</div>
    /*END SUPPORT*/
    <div id="splash">
        <h1>ASL <b>FLIGHT SIMULATOR</b></h1>
        <p id="plane-chooser-title">CHOOSE YOUR PLANE</p>
    
        <div id="plane-model-container">
            <button id="prev-plane" class="model-nav-button" onclick="changePlane(-1)">&#9664;</button> 
            <button id="next-plane" class="model-nav-button" onclick="changePlane(1)">&#9658;</button> 
        </div>
        
        <div id="plane-info-display">
            <p class="plane-title" id="plane-name">Future Aircraft</p>
            <div class="stats-grid">
                <div>Mass: <span id="stat-mass" class="stat-value">0</span> KG</div>
                <div>Max Thrust: <span id="stat-thrust" class="stat-value">0</span> kN</div>
                <div>Lift Coeff: <span id="stat-lift" class="stat-value">0.0</span></div>
                <div>Ground Clearance: <span id="stat-height" class="stat-value">0.0</span> m</div>
            </div>
        </div>

        <div class="controls-grid">
            <div><span class="key-box">SHIFT</span> Increase engine power/thrust.</div>
            <div><span class="key-box">SPACE</span> Apply wheel brakes or air brakes.</div>
            <div><span class="key-box">W / S</span> Pitch the nose up or down (elevator control).</div>
            <div><span class="key-box">A / D</span> Roll the aircraft left or right using ailerons</div>
            <div><span class="key-box">Q / E</span> Steer left or right using the rudder. </div>
            <div><span class="key-box">V</span> Change camera view. </div>
        </div>
    
        <div style="margin-top:20px; color:#c0e0f0; font-size:13px; opacity: 0.8;">
            C'est mon jeu
            <br> Â© 2025 Zhanyi Zhou (ASL) All rights reserved
        </div>
    
        <button id="start-button" onclick="startGame()">INITIALIZE SYSTEMS</button>
    </div>
    
    <div id="loading-screen">
        <p>Loading Game Assets...</p>
        <div id="loading-progress-bar">
            <div id="loading-progress-fill"></div>
        </div>
        <p id="loading-status" style="margin-top:10px; font-size:14px;">(0%)</p>
    </div>

    <div id="hud-layer">
        <div class="hud-top-left">
            <div class="instrument">
                <span class="label">Airspeed</span>
                <span class="value" id="hud-spd">0</span> <span class="unit">KTS</span>
            </div>
            <div class="instrument">
                <span class="label">Altitude</span>
                <span class="value" id="hud-alt">0</span> <span class="unit">FT</span>
            </div>
            <div class="instrument">
                <span class="label">Heading</span>
                <span class="value" id="hud-hdg">000</span> <span class="unit">DEG</span>
            </div>
            <div class="instrument" style="border-left-color: #ff9900;">
                <span class="label" style="color:#ff9900">Vert Speed</span>
                <span class="value" id="hud-vs">0</span> <span class="unit">FT/S</span>
            </div>
            <div class="instrument" style="border-left-color: #ffcc00;">
                <span class="label" style="color:#ffcc00">Thrust</span>
                <span class="value" id="hud-rpm">0</span> <span class="unit">%</span>
            </div>
        </div>
    
        <div id="quality-selector">
            <span class="label">Graphics Quality</span>
            <div class="button-group">
                <button id="btn-sd" onclick="setQuality('SD')" class="active">SD (Smooth)</button>
                <button id="btn-hd" onclick="setQuality('HD')">HD (High)</button>
            </div>
        </div>

        <div id="throttle-wrapper">
            <div id="throttle-fill"></div>
        </div>
        <div id="throttle-label">THRUST</div>
        
        <div id="center-warning">STALL WARNING</div>
    </div>

    <div id="canvas-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

<script>
    /* ASL FLIGHT SIMULATOR - æ ¸å¿ƒç‰©ç†ä¸åœºæ™¯å˜é‡ */
    let scene, camera, renderer, clock;
    let aircraft, cityModel;
    let isGameRunning = false;
    let currentPlaneIndex = 0;

    // é£æœºç‰©ç†çŠ¶æ€ (åˆå§‹é«˜åº¦æå‡è‡³ 50 ä»¥é€‚é…åŸå¸‚æ¨¡å‹)
    const physics = {
        pos: new THREE.Vector3(0, 50, 0), 
        vel: new THREE.Vector3(0, 0, 0),
        quat: new THREE.Quaternion(),
        angVel: new THREE.Vector3(0, 0, 0),
        throttle: 0,
        config: {
            mass: 1200,
            maxThrust: 22,
            liftCoeff: 0.12,
            dragCoeff: 0.02,
            gravity: 9.81
        }
    };

    const keys = {};
    let cameraMode = 'chase'; 
    let orbitAlpha = 0, orbitBeta = Math.PI / 3, orbitDistance = 15;

    // é£æœºé…ç½®è¡¨
    const planes = [
        { name: "Cessna 172", mass: 1100, thrust: 18, lift: 0.12, height: 1.2 },
        { name: "Extra 330", mass: 800, thrust: 25, lift: 0.10, height: 1.0 },
        { name: "A-10 Warthog", mass: 12000, thrust: 80, lift: 0.08, height: 3.5 }
    ];

    // --- é£æœºé¢„è§ˆåœºæ™¯å˜é‡ ---
    let previewScene, previewCamera, previewRenderer, previewModel;

    /* 1. åˆå§‹åŒ–é£æœºé¢„è§ˆ (Splash Screen) */
    function initPlanePreview() {
        const container = document.getElementById('plane-model-container');
        previewScene = new THREE.Scene();
        previewCamera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 100);
        previewCamera.position.set(5, 3, 8);
        previewCamera.lookAt(0, 0, 0);

        previewRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        previewRenderer.setSize(container.clientWidth, container.clientHeight);
        previewRenderer.setClearColor(0x000000, 0);
        container.appendChild(previewRenderer.domElement);

        const ambient = new THREE.AmbientLight(0xffffff, 0.8);
        previewScene.add(ambient);
        const sun = new THREE.DirectionalLight(0xffffff, 1);
        sun.position.set(5, 10, 5);
        previewScene.add(sun);

        loadPreviewModel();
    }

    function loadPreviewModel() {
        if (previewModel) previewScene.remove(previewModel);
        const p = planes[currentPlaneIndex];
        const geo = new THREE.BoxGeometry(4, 0.8, 2);
        const mat = new THREE.MeshPhongMaterial({ color: 0x00aaff });
        previewModel = new THREE.Mesh(geo, mat);
        previewScene.add(previewModel);
    }

    function updatePlanePreview() {
        if (previewModel) {
            previewModel.rotation.y += 0.01;
            previewRenderer.render(previewScene, previewCamera);
        }
        if (!isGameRunning) requestAnimationFrame(updatePlanePreview);
    }

    /* 2. ä¸»æ¸¸æˆåˆå§‹åŒ– */
    function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87ceeb);
        
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 50000);
        
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        clock = new THREE.Clock();

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);

        const sunLight = new THREE.DirectionalLight(0xffffff, 1.0);
        sunLight.position.set(500, 1000, 250);
        sunLight.castShadow = true;
        scene.add(sunLight);

        // --- æ ¸å¿ƒé›†æˆï¼šåŠ è½½åŸå¸‚æ¨¡å‹ ---
        loadCity();

        window.addEventListener('keydown', (e) => {
            keys[e.code] = true;
            if (e.code === 'KeyV') {
                cameraMode = (cameraMode === 'chase') ? 'cockpit' : 'chase';
            }
        });
        window.addEventListener('keyup', (e) => keys[e.code] = false);
        window.addEventListener('resize', onWindowResize);
        
        updatePlaneInfo();
        initPlanePreview();
        updatePlanePreview();
    }

    /* 3. ä» CS ä»£ç ç§»æ¤çš„ loadCity å‡½æ•° */
    function loadCity() {
        const loader = new THREE.GLTFLoader();
        const statusEl = document.getElementById('loading-status');
        const fillEl = document.getElementById('loading-progress-fill');

        loader.load('city.glb', function (gltf) {
            cityModel = gltf.scene;
            scene.add(cityModel);

            cityModel.traverse(function (node) {
                if (node.isMesh) {
                    node.receiveShadow = true;
                    node.castShadow = true;
                }
            });
            console.log("City Map Loaded Successfully.");
        }, 
        (xhr) => {
            if (xhr.lengthComputable) {
                const percent = Math.floor((xhr.loaded / xhr.total) * 100);
                if(statusEl) statusEl.innerText = `(${percent}%) Loading City Map...`;
                if(fillEl) fillEl.style.width = percent + '%';
            }
        }, 
        (err) => {
            console.error("Error loading city.glb:", err);
        });
    }

    function loadAircraft() {
        const p = planes[currentPlaneIndex];
        const group = new THREE.Group();
        
        const bodyGeo = new THREE.BoxGeometry(0.8, 0.8, 4);
        const bodyMat = new THREE.MeshPhongMaterial({ color: 0xeeeeee });
        const body = new THREE.Mesh(bodyGeo, bodyMat);
        group.add(body);

        const wingGeo = new THREE.BoxGeometry(5, 0.1, 1.2);
        const wing = new THREE.Mesh(wingGeo, bodyMat);
        wing.position.set(0, 0, 0);
        group.add(wing);

        const tailGeo = new THREE.BoxGeometry(1.5, 0.1, 0.8);
        const tail = new THREE.Mesh(tailGeo, bodyMat);
        tail.position.set(0, 0, 1.8);
        group.add(tail);

        const vTailGeo = new THREE.BoxGeometry(0.1, 0.8, 0.6);
        const vTail = new THREE.Mesh(vTailGeo, bodyMat);
        vTail.position.set(0, 0.4, 1.8);
        group.add(vTail);

        aircraft = group;
        aircraft.castShadow = true;
        scene.add(aircraft);
        
        physics.pos.y = 50; // ç¡®ä¿åœ¨åŸå¸‚ä¸Šæ–¹
    }

    /* 4. ç‰©ç†å¼•æ“ (å®Œæ•´ä¿ç•™åŸæœ‰é€»è¾‘) */
    function updatePhysics(delta) {
        if (!isGameRunning) return;

        // æ²¹é—¨æ§åˆ¶
        if (keys['ShiftLeft']) physics.throttle = Math.min(physics.throttle + delta * 0.4, 1.0);
        if (keys['Space']) physics.throttle = Math.max(physics.throttle - delta * 0.8, 0.0);

        // å§¿æ€æ§åˆ¶
        const rotImpulse = new THREE.Vector3(0, 0, 0);
        const sensitivity = 1.2;
        if (keys['KeyW']) rotImpulse.x = -sensitivity;
        if (keys['KeyS']) rotImpulse.x = sensitivity;
        if (keys['KeyA']) rotImpulse.z = sensitivity;
        if (keys['KeyD']) rotImpulse.z = -sensitivity;
        if (keys['KeyQ']) rotImpulse.y = sensitivity;
        if (keys['KeyE']) rotImpulse.y = -sensitivity;

        const q = new THREE.Quaternion().setFromEuler(new THREE.Euler(rotImpulse.x * delta, rotImpulse.y * delta, rotImpulse.z * delta, 'YXZ'));
        physics.quat.multiply(q);

        // åŠ¨åŠ›å­¦è®¡ç®—
        const forward = new THREE.Vector3(0, 0, -1).applyQuaternion(physics.quat);
        const thrust = forward.clone().multiplyScalar(physics.throttle * physics.config.maxThrust);
        
        const gravity = new THREE.Vector3(0, -physics.config.gravity, 0);
        const speed = physics.vel.length();
        const lift = new THREE.Vector3(0, speed * physics.config.liftCoeff * (1 + physics.throttle), 0).applyQuaternion(physics.quat);

        const accel = new THREE.Vector3().add(thrust).add(gravity).add(lift);
        physics.vel.add(accel.multiplyScalar(delta));
        physics.vel.multiplyScalar(1.0 - (physics.config.dragCoeff * (speed * 0.1)));

        physics.pos.add(physics.vel.clone().multiplyScalar(delta));

        // åœ°é¢ç¢°æ’ä¿æŠ¤ (é’ˆå¯¹åŸå¸‚åœ°å½¢è°ƒæ•´ä¸º 2.0)
        if (physics.pos.y < 2.0) {
            physics.pos.y = 2.0;
            physics.vel.y = 0;
            document.getElementById('center-warning').style.display = 'block';
        } else {
            document.getElementById('center-warning').style.display = 'none';
        }

        if (aircraft) {
            aircraft.position.copy(physics.pos);
            aircraft.quaternion.copy(physics.quat);
        }
    }

    /* 5. æ¸²æŸ“å¾ªç¯ä¸ UI æ›´æ–° */
    function animate() {
        requestAnimationFrame(animate);
        const delta = clock.getDelta();

        updatePhysics(delta);
        
        if (aircraft) {
            if (cameraMode === 'chase') {
                const offset = new THREE.Vector3(0, 5, 15).applyQuaternion(physics.quat);
                camera.position.lerp(physics.pos.clone().add(offset), 0.1);
                camera.lookAt(physics.pos);
            } else {
                camera.position.copy(physics.pos);
                camera.quaternion.copy(physics.quat);
            }
        }

        updateHUD();
        renderer.render(scene, camera);
    }

    function updateHUD() {
        document.getElementById('hud-spd').innerText = Math.floor(physics.vel.length() * 1.94);
        document.getElementById('hud-alt').innerText = Math.floor(physics.pos.y * 3.28);
        document.getElementById('hud-rpm').innerText = Math.floor(physics.throttle * 100);
        document.getElementById('throttle-fill').style.height = (physics.throttle * 100) + '%';
        
        const euler = new THREE.Euler().setFromQuaternion(physics.quat);
        let hdg = Math.floor(THREE.MathUtils.radToDeg(-euler.y) % 360);
        if (hdg < 0) hdg += 360;
        document.getElementById('hud-hdg').innerText = hdg.toString().padStart(3, '0');
        document.getElementById('hud-vs').innerText = Math.floor(physics.vel.y * 196);
    }

    function startGame() {
        document.getElementById('splash').style.display = 'none';
        document.getElementById('loading-screen').style.display = 'flex';
        
        setTimeout(() => {
            document.getElementById('loading-screen').style.display = 'none';
            isGameRunning = true;
            loadAircraft();
        }, 2000);
    }

    function changePlane(dir) {
        currentPlaneIndex = (currentPlaneIndex + dir + planes.length) % planes.length;
        updatePlaneInfo();
        loadPreviewModel();
    }

    function updatePlaneInfo() {
        const p = planes[currentPlaneIndex];
        document.getElementById('plane-name').innerText = p.name;
        document.getElementById('stat-mass').innerText = p.mass;
        document.getElementById('stat-thrust').innerText = p.thrust;
        document.getElementById('stat-lift').innerText = p.lift;
        document.getElementById('stat-height').innerText = p.height;
        
        physics.config.mass = p.mass;
        physics.config.maxThrust = p.thrust;
        physics.config.liftCoeff = p.lift;
    }

    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function closeNotice() {
        document.getElementById('notice-modal').style.display = 'none';
    }

    function setQuality(q) {
        if (q === 'low') renderer.setPixelRatio(0.5);
        else if (q === 'med') renderer.setPixelRatio(1);
        else renderer.setPixelRatio(window.devicePixelRatio);
    }

    // æ‰§è¡Œå¯åŠ¨
    init();
    animate();
</script>
</body>
</html>
