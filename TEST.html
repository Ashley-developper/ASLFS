<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASL CITY FLIGHT SIMULATOR</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Rajdhani', 'Segoe UI', sans-serif; user-select: none; }
        #hud-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column; justify-content: space-between;
            padding: 25px; box-sizing: border-box; z-index: 10;
        }
        .hud-top-left { display: flex; gap: 20px; flex-wrap: wrap; }
        .instrument {
            background: rgba(10, 20, 30, 0.75); 
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-left: 4px solid #00aaff;
            backdrop-filter: blur(8px); 
            padding: 10px 18px; 
            color: #eee; 
            min-width: 110px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            clip-path: polygon(0 0, 100% 0, 100% 80%, 90% 100%, 0 100%);
        }
        .label { font-family: 'Orbitron', sans-serif; font-size: 10px; color: #88ccff; font-weight: 600; letter-spacing: 1px; margin-bottom: 4px; display:block; text-transform: uppercase;}
        .value { font-family: 'Orbitron', sans-serif; font-size: 26px; font-weight: 700; letter-spacing: -1px; }
        .unit { font-size: 12px; color: #888; margin-left: 4px; font-weight: 400;}
        #throttle-wrapper {
            position: absolute; left: 30px; bottom: 120px; width: 12px; height: 240px;
            background: rgba(0,0,0,0.6); border: 1px solid #555; border-radius: 8px; padding: 2px;
        }
        #throttle-fill {
            position: absolute; bottom: 2px; left: 2px; width: 12px; height: 0%;
            background: linear-gradient(to top, #4caf50, #ffeb3b, #ff5722);
            border-radius: 4px; transition: height 0.1s;
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.2; } }
        #center-warning {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #ff3333; font-size: 24px; font-weight: bold; border: 2px solid #ff3333;
            padding: 10px 30px; background: rgba(0,0,0,0.7); display: none; animation: blink 0.5s step-end infinite;
        }
        #splash {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #001a2e 0%, #000000 100%);
            z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white;
        }
        #plane-model-container {
            width: 600px; height: 300px; margin: 20px 0; background: rgba(255, 255, 255, 0.05);
            border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); overflow: hidden; position: relative;
        }
        .model-nav-button {
            position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0, 170, 255, 0.3);
            border: none; color: white; padding: 15px; cursor: pointer; font-size: 24px; z-index: 10; transition: 0.3s;
        }
        .model-nav-button:hover { background: rgba(0, 170, 255, 0.6); }
        #prev-plane { left: 10px; border-radius: 50%; }
        #next-plane { right: 10px; border-radius: 50%; }
        #plane-info-display {
            text-align: center; margin-top: 15px; padding: 15px 30px; background: rgba(255, 255, 255, 0.05);
            border-radius: 8px; border: 1px solid rgba(0, 170, 255, 0.2); min-width: 450px;
        }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px 20px; font-size: 13px; color: #88ccff; }
        .controls-grid {
            display: grid; grid-template-columns: auto auto; gap: 10px 20px; margin-top: 20px;
            text-align: left; background: rgba(0,0,0,0.5); padding: 20px; border-radius: 8px; font-size: 14px;
        }
        .key-box { font-family: 'Orbitron', monospace; color: #00ffff; font-weight: bold; margin-right: 8px; }
        button#start-button {
            margin-top: 40px; padding: 14px 60px; font-size: 18px; font-family: 'Orbitron'; font-weight: 700;
            border: none; background: #00aaff; color: #fff; cursor: pointer; letter-spacing: 2px;
            transition: 0.3s; border-radius: 4px; clip-path: polygon(10% 0, 100% 0, 90% 100%, 0 100%);
        }
        button#start-button:hover { background: #ff00ff; box-shadow: 0 0 30px rgba(255, 0, 255, 0.5); }
        #loading-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; color: #00ffff;
        }
        #loading-progress-bar { width: 400px; height: 4px; background: #222; margin-top: 20px; }
        #loading-progress-fill { height: 100%; width: 0%; background: #00ffff; transition: width 0.3s; }
    </style>
</head>
<body>
    <div id="splash">
        <h1 style="font-family:'Orbitron'; letter-spacing:8px; margin:0;">ASL CITY FLIGHT</h1>
        <div id="plane-model-container">
            <button id="prev-plane" class="model-nav-button" onclick="changePlane(-1)">&#9664;</button>
            <button id="next-plane" class="model-nav-button" onclick="changePlane(1)">&#9658;</button>
        </div>
        <div id="plane-info-display">
            <p id="plane-name" style="font-family:'Orbitron'; font-size:20px; margin-bottom:10px; color:#00ffff;">Aircraft Name</p>
            <div class="stats-grid">
                <div>Mass: <span id="stat-mass">0</span> KG</div>
                <div>Thrust: <span id="stat-thrust">0</span> kN</div>
                <div>Lift: <span id="stat-lift">0.0</span></div>
                <div>Height: <span id="stat-height">0.0</span> m</div>
            </div>
        </div>
        <div class="controls-grid">
            <div><span class="key-box">SHIFT</span> Increase Thrust</div>
            <div><span class="key-box">SPACE</span> Brake</div>
            <div><span class="key-box">W / S</span> Pitch Up/Down</div>
            <div><span class="key-box">A / D</span> Roll Left/Right</div>
            <div><span class="key-box">Q / E</span> Rudder Yaw</div>
            <div><span class="key-box">V</span> Camera View</div>
        </div>
        <button id="start-button" onclick="startGame()">INITIALIZE SYSTEMS</button>
    </div>

    <div id="loading-screen">
        <h2 style="font-family:'Orbitron';">LOADING CITY ASSETS</h2>
        <div id="loading-progress-bar"><div id="loading-progress-fill"></div></div>
        <p id="loading-status">(0%)</p>
    </div>

    <div id="hud-layer" style="display:none;">
        <div class="hud-top-left">
            <div class="instrument"><span class="label">Airspeed</span><span class="value" id="hud-spd">0</span><span class="unit">KTS</span></div>
            <div class="instrument"><span class="label">Altitude</span><span class="value" id="hud-alt">0</span><span class="unit">FT</span></div>
            <div class="instrument"><span class="label">Heading</span><span class="value" id="hud-hdg">000</span><span class="unit">DEG</span></div>
            <div class="instrument"><span class="label">Vertical Speed</span><span class="value" id="hud-vs">0</span><span class="unit">FPS</span></div>
        </div>
        <div id="throttle-wrapper"><div id="throttle-fill"></div></div>
        <div id="center-warning">PULL UP</div>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        const PlaneConfig = [
            { name: "Cessna 172 Custom", mass: 1100, enginePower: 8500, liftCoeff: 0.45, dragCoeff: 0.035, modelPath: 'https://raw.githubusercontent.com/Ashley-developper/Ashley-developper.github.io/main/airplane_1.glb', groundClearance: 1.2 },
            { name: "Executive Jet", mass: 5500, enginePower: 45000, liftCoeff: 0.38, dragCoeff: 0.022, modelPath: 'https://raw.githubusercontent.com/Ashley-developper/Ashley-developper.github.io/main/airplane_2.glb', groundClearance: 2.1 },
            { name: "STOL Utility", mass: 900, enginePower: 12000, liftCoeff: 0.65, dragCoeff: 0.05, modelPath: 'https://raw.githubusercontent.com/Ashley-developper/Ashley-developper.github.io/main/airplane_3.glb', groundClearance: 1.5 }
        ];

        let currentPlaneIndex = 0;
        let scene, camera, renderer, clock;
        let aircraftModel, cityModel;
        let isGameRunning = false;
        let cameraMode = 'chase'; 

        const controls = { w: false, s: false, a: false, d: false, q: false, e: false, shift: false, space: false };
        
        class AircraftPhysics {
            constructor() {
                this.pos = new THREE.Vector3(0, 200, 500);
                this.vel = new THREE.Vector3(0, 0, 0);
                this.quat = new THREE.Quaternion().setFromEuler(new THREE.Euler(0, Math.PI, 0));
                this.angularVel = new THREE.Vector3(0, 0, 0);
                this.throttle = 0;
                this.config = PlaneConfig[currentPlaneIndex];
            }

            update(dt) {
                const config = this.config;
                const euler = new THREE.Euler().setFromQuaternion(this.quat, 'YXZ');
                
                const forward = new THREE.Vector3(0, 0, -1).applyQuaternion(this.quat);
                const up = new THREE.Vector3(0, 1, 0).applyQuaternion(this.quat);
                const right = new THREE.Vector3(1, 0, 0).applyQuaternion(this.quat);

                const forwardSpeed = -this.vel.dot(forward);
                const speed = this.vel.length();

                const thrustForce = forward.clone().multiplyScalar(this.throttle * config.enginePower);
                
                const airDensity = 1.225 * Math.exp(-this.pos.y / 8000);
                const liftMag = config.liftCoeff * Math.pow(Math.max(0, forwardSpeed), 2) * airDensity;
                const liftForce = up.clone().multiplyScalar(liftMag);

                const dragMag = config.dragCoeff * Math.pow(speed, 2) * airDensity;
                const dragForce = this.vel.clone().normalize().multiplyScalar(-dragMag);

                const gravityForce = new THREE.Vector3(0, -9.81 * config.mass, 0);

                const totalForce = new THREE.Vector3().add(thrustForce).add(liftForce).add(dragForce).add(gravityForce);
                const accel = totalForce.divideScalar(config.mass);
                this.vel.add(accel.multiplyScalar(dt));
                this.pos.add(this.vel.clone().multiplyScalar(dt));

                const targetAngularVel = new THREE.Vector3(0, 0, 0);
                if (controls.w) targetAngularVel.x = 1.5;
                if (controls.s) targetAngularVel.x = -1.5;
                if (controls.a) targetAngularVel.z = 2.0;
                if (controls.d) targetAngularVel.z = -2.0;
                if (controls.q) targetAngularVel.y = 0.8;
                if (controls.e) targetAngularVel.y = -0.8;

                this.angularVel.lerp(targetAngularVel, dt * 3.0);
                
                const deltaQuat = new THREE.Quaternion().setFromEuler(
                    new THREE.Euler(
                        this.angularVel.x * dt,
                        this.angularVel.y * dt,
                        this.angularVel.z * dt,
                        'YXZ'
                    )
                );
                this.quat.multiply(deltaQuat);

                if (this.pos.y < config.groundClearance) {
                    this.pos.y = config.groundClearance;
                    this.vel.y = Math.max(0, this.vel.y);
                    const localVel = this.vel.clone().applyQuaternion(this.quat.clone().invert());
                    localVel.x *= 0.9;
                    if (controls.space) localVel.z *= 0.95;
                    this.vel.copy(localVel.applyQuaternion(this.quat));
                }
            }
        }

        const physics = new AircraftPhysics();

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x050b1a);
            scene.fog = new THREE.FogExp2(0x050b1a, 0.0005);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 20000);
            
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.toneMapping = THREE.ReinhardToneMapping;
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambientLight);
            const sunLight = new THREE.DirectionalLight(0xffffff, 1.2);
            sunLight.position.set(500, 1000, 500);
            scene.add(sunLight);

            clock = new THREE.Clock();
            updateSplashInfo();
            initSplashPreview();

            window.addEventListener('keydown', (e) => handleKey(e.key.toLowerCase(), true));
            window.addEventListener('keyup', (e) => handleKey(e.key.toLowerCase(), false));
            window.addEventListener('resize', onWindowResize);
        }

        function handleKey(key, isPressed) {
            if (key === 'w') controls.w = isPressed;
            if (key === 's') controls.s = isPressed;
            if (key === 'a') controls.a = isPressed;
            if (key === 'd') controls.d = isPressed;
            if (key === 'q') controls.q = isPressed;
            if (key === 'e') controls.e = isPressed;
            if (key === 'shift') controls.shift = isPressed;
            if (key === ' ') controls.space = isPressed;
            if (isPressed && key === 'v') {
                cameraMode = cameraMode === 'chase' ? 'cockpit' : 'chase';
            }
        }

        let previewScene, previewCamera, previewRenderer, previewPlane;
        function initSplashPreview() {
            const container = document.getElementById('plane-model-container');
            previewScene = new THREE.Scene();
            previewCamera = new THREE.PerspectiveCamera(45, 600 / 300, 0.1, 100);
            previewCamera.position.set(5, 3, 8);
            previewCamera.lookAt(0, 0, 0);

            previewRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            previewRenderer.setSize(600, 300);
            container.appendChild(previewRenderer.domElement);

            const light = new THREE.DirectionalLight(0xffffff, 1.5);
            light.position.set(5, 5, 5);
            previewScene.add(light);
            previewScene.add(new THREE.AmbientLight(0xffffff, 0.6));

            loadPreviewModel();
            animatePreview();
        }

        function loadPreviewModel() {
            if (previewPlane) previewScene.remove(previewPlane);
            new GLTFLoader().load(PlaneConfig[currentPlaneIndex].modelPath, (gltf) => {
                previewPlane = gltf.scene;
                previewScene.add(previewPlane);
            });
        }

        function animatePreview() {
            requestAnimationFrame(animatePreview);
            if (previewPlane) previewPlane.rotation.y += 0.01;
            previewRenderer.render(previewScene, previewCamera);
        }

        window.changePlane = function(delta) {
            currentPlaneIndex = (currentPlaneIndex + delta + PlaneConfig.length) % PlaneConfig.length;
            physics.config = PlaneConfig[currentPlaneIndex];
            updateSplashInfo();
            loadPreviewModel();
        };

        function updateSplashInfo() {
            const p = PlaneConfig[currentPlaneIndex];
            document.getElementById('plane-name').innerText = p.name;
            document.getElementById('stat-mass').innerText = p.mass;
            document.getElementById('stat-thrust').innerText = (p.enginePower / 1000).toFixed(1);
            document.getElementById('stat-lift').innerText = p.liftCoeff;
            document.getElementById('stat-height').innerText = p.groundClearance;
        }

        window.startGame = function() {
            document.getElementById('splash').style.display = 'none';
            document.getElementById('loading-screen').style.display = 'flex';
            
            const loader = new GLTFLoader();
            let loadedCount = 0;

            loader.load('https://raw.githubusercontent.com/Ashley-developper/Ashley-developper.github.io/main/city_1.glb', (gltf) => {
                cityModel = gltf.scene;
                scene.add(cityModel);
                checkAssets();
            }, (xhr) => updateProgress('City', xhr));

            loader.load(PlaneConfig[currentPlaneIndex].modelPath, (gltf) => {
                aircraftModel = gltf.scene;
                scene.add(aircraftModel);
                checkAssets();
            }, (xhr) => updateProgress('Aircraft', xhr));

            function checkAssets() {
                loadedCount++;
                if (loadedCount >= 2) {
                    document.getElementById('loading-screen').style.display = 'none';
                    document.getElementById('hud-layer').style.display = 'flex';
                    isGameRunning = true;
                    animate();
                }
            }
        };

        function updateProgress(name, xhr) {
            const percent = Math.floor((xhr.loaded / xhr.total) * 100);
            document.getElementById('loading-progress-fill').style.width = percent + '%';
            document.getElementById('loading-status').innerText = name + ': ' + percent + '%';
        }

        function animate() {
            if (!isGameRunning) return;
            requestAnimationFrame(animate);

            const dt = Math.min(clock.getDelta(), 0.1);

            if (controls.shift) physics.throttle = Math.min(1, physics.throttle + dt * 0.5);
            else physics.throttle = Math.max(0, physics.throttle - dt * 0.2);

            physics.update(dt);

            if (aircraftModel) {
                aircraftModel.position.copy(physics.pos);
                aircraftModel.quaternion.copy(physics.quat);
            }

            updateCamera();
            updateHUD();
            renderer.render(scene, camera);
        }

        function updateCamera() {
            const offset = cameraMode === 'chase' ? new THREE.Vector3(0, 5, 15) : new THREE.Vector3(0, 0.5, -0.5);
            offset.applyQuaternion(physics.quat);
            camera.position.copy(physics.pos).add(offset);
            
            const lookTarget = physics.pos.clone();
            if (cameraMode === 'chase') {
                const lookOffset = new THREE.Vector3(0, 2, -10).applyQuaternion(physics.quat);
                camera.lookAt(lookTarget.add(lookOffset));
            } else {
                const lookOffset = new THREE.Vector3(0, 0, -10).applyQuaternion(physics.quat);
                camera.lookAt(lookTarget.add(lookOffset));
            }
        }

        function updateHUD() {
            const speedKts = Math.floor(physics.vel.length() * 1.94);
            const altFt = Math.floor(physics.pos.y * 3.28);
            const vsFps = Math.floor(physics.vel.y * 3.28);
            
            const euler = new THREE.Euler().setFromQuaternion(physics.quat, 'YXZ');
            let hdg = Math.floor(THREE.MathUtils.radToDeg(-euler.y) % 360);
            if (hdg < 0) hdg += 360;

            document.getElementById('hud-spd').innerText = speedKts;
            document.getElementById('hud-alt').innerText = altFt;
            document.getElementById('hud-hdg').innerText = hdg.toString().padStart(3, '0');
            document.getElementById('hud-vs').innerText = vsFps;
            document.getElementById('throttle-fill').style.height = (physics.throttle * 100) + '%';

            const warning = document.getElementById('center-warning');
            if (physics.pos.y < 50 && physics.vel.y < -5 && speedKts > 40) {
                warning.style.display = 'block';
            } else {
                warning.style.display = 'none';
            }
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        init();
    </script>
</body>
</html>
