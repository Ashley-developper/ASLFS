<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASL Car Simulator</title>
    <style>
        /* ========================================================
        ğŸš€ æ ·å¼ï¼šæ¥è‡ª index.html çš„ç°ä»£ã€ç§‘å¹»é£æ ¼ UI æ ·å¼
        ======================================================== 
        */
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; user-select: none; }
        
        /* ä»ªè¡¨ç›˜å¸ƒå±€ */
        #hud-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column; justify-content: space-between;
            padding: 25px; box-sizing: border-box; z-index: 10;
        }

        .hud-top-left { display: flex; gap: 20px; }
        
        .instrument {
            background: rgba(10, 20, 30, 0.75); 
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-left: 4px solid #00aaff;
            backdrop-filter: blur(8px); 
            padding: 10px 18px; 
            color: #eee; 
            min-width: 100px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        
        .label { font-size: 10px; color: #88ccff; font-weight: 600; letter-spacing: 1px; margin-bottom: 4px; display:block; text-transform: uppercase;}
        .value { font-size: 26px; font-weight: 700; font-family: 'Consolas', monospace; letter-spacing: -1px; }
        .unit { font-size: 12px; color: #888; margin-left: 4px; font-weight: 400;}

        /* è­¦å‘Šä¿¡æ¯ */
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.2; }
        }

        #center-warning {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #ff3333; font-size: 24px; font-weight: bold; border: 2px solid #ff3333;
            padding: 10px 30px; background: rgba(0,0,0,0.7); display: none;
            animation: blink 0.5s step-end infinite;
        }

        /* å¯åŠ¨ç”»é¢ (Splash Screen) */
        #splash {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            /* ğŸ¨ å¤©è“è‰²ç«‹ä½“èƒŒæ™¯ */
            background: linear-gradient(135deg, #0093E9 0%, #80D0C7 100%);
            z-index: 999; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white;
            /* æŠ•å½±æ•ˆæœ */
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.4); 
        }
        /* æ–°å¢ï¼šTHREE.js å®¹å™¨åœ¨å¯åŠ¨ç”»é¢ä¸­ */
        #splash-three-container {
            width: 300px; /* 3D æ¨¡å‹åŒºåŸŸå®½åº¦ */
            height: 150px; /* 3D æ¨¡å‹åŒºåŸŸé«˜åº¦ */
            margin-bottom: 20px;
            position: relative;
        }

        h1 { 
            font-size: 32px; 
            margin: 0; 
            font-weight: 400; 
            letter-spacing: 5px; 
            text-transform: uppercase;
            color: #fff;
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.4); 
        }

        /* æ ‡é¢˜æ ·å¼ï¼šChoose Your Plane -> City Drive Mode */
        #plane-chooser-title {
            font-size: 20px; 
            margin-bottom: 20px; 
            font-weight: 600; 
            color: #f0f0f0; 
            letter-spacing: 3px;
        }

        /* é£æœºå‚æ•°å±•ç¤ºåŒºæ ·å¼ (Car Stats Display) */
        #plane-info-display {
            text-align: center;
            margin-top: 15px;
            padding: 15px 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            min-width: 450px;
        }

        .plane-title {
            font-size: 18px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 10px;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px 20px;
            font-size: 13px;
            color: #c0e0f0;
        }

        .stat-value {
            font-family: 'Consolas', monospace;
            font-weight: bold;
            color: #80D0C7;
            margin-left: 5px;
        }

        /* æŒ‰é’®å’Œæ§åˆ¶ç½‘æ ¼æ ·å¼æ›´æ–° */
        .controls-grid {
            display: grid; grid-template-columns: auto auto; gap: 10px 20px; 
            margin-top: 20px;
            text-align: left; 
            background: rgba(0,0,0,0.3); /* æ·±è‰²é€æ˜èƒŒæ™¯ */
            padding: 20px; 
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            font-size: 14px;
        }

        .key-box { 
            font-family: 'Consolas', monospace; 
            color: #80D0C7; /* åŒ¹é…ä¸»é¢˜è‰² */
            font-weight: bold; 
            margin-right: 8px;
            background: rgba(255, 255, 255, 0.15);
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #80D0C7;
        }

        button#start-button {
            margin-top: 40px; 
            padding: 14px 50px; 
            font-size: 16px; 
            font-weight: 700; 
            border: none; /* ç§»é™¤è¾¹æ¡† */
            background: #0093E9; 
            color: #fff; 
            cursor: pointer; 
            letter-spacing: 2px;
            transition: all 0.3s; 
            text-transform: uppercase;
            border-radius: 30px; /* åœ†è§’æŒ‰é’® */
            box-shadow: 0 6px 20px rgba(0, 147, 233, 0.6);
        }
        button#start-button:hover { 
            background: #80D0C7; 
            color: #000; 
            box-shadow: 0 6px 25px rgba(128, 208, 199, 0.8); 
        }
        button#start-button:active {
            transform: translateY(2px);
            box-shadow: 0 3px 10px rgba(0, 147, 233, 0.6);
        }

        /* Loading ç•Œé¢æ ·å¼ */
        #loading-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000; 
            display: none; 
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
        }

        #loading-progress-bar {
            width: 300px;
            height: 10px;
            margin-top: 20px;
            background: #555;
            border-radius: 5px;
            overflow: hidden;
        }

        #loading-progress-fill {
            height: 100%;
            width: 0%;
            background: #00aaff;
            transition: width 0.3s;
        }
    </style>
</head>
<body>

    <div id="splash">
        <h1>ASL <b>CAR SIMULATOR</b></h1>
        <p id="plane-chooser-title">CITY DRIVE MODE</p>
        
        <div id="splash-three-container"></div> 
    
        <div id="plane-info-display" style="min-width:350px;">
            <p class="plane-title" id="plane-name">SPORTS CAR Râ€‘1</p>
            <div class="stats-grid">
                <div>Mass: <span id="stat-mass" class="stat-value">1500</span> KG</div>
                <div>Power: <span id="stat-thrust" class="stat-value">300</span> HP</div>
                <div>Torque: <span id="stat-lift" class="stat-value">900</span> Nm</div>
                <div>Redline: <span id="stat-height" class="stat-value">7500</span> RPM</div>
            </div>
        </div>

        <div class="controls-grid">
            <div><span class="key-box">W</span> Accelerate</div>
            <div><span class="key-box">S</span> Brake / Reverse</div>
            <div><span class="key-box">A / D</span> Steer Left / Right</div>
            <div><span class="key-box">SPACE</span> Handbrake (Rear-wheel drift)</div>
            <div><span class="key-box">V</span> Change camera view</div>
        </div>
    
        <div style="margin-top:20px; color:#c0e0f0; font-size:13px; opacity: 0.8;">
            Â© 2025 Zhanyi Zhou (ASL) All rights reserved
        </div>
    
        <button id="start-button" onclick="startGame()">START DRIVING</button>
    </div>
    
    <div id="loading-screen">
        <p>Loading City and Assets...</p>
        <div id="loading-progress-bar">
            <div id="loading-progress-fill"></div>
        </div>
        <p id="loading-status" style="margin-top:10px; font-size:14px;">(0%)</p>
    </div>

    <div id="hud-layer" style="display:none;">
        <div class="hud-top-left">
            <div class="instrument">
                <span class="label">Speed</span>
                <span class="value" id="hud-spd">0</span> <span class="unit">KM/H</span>
            </div>
            <div class="instrument">
                <span class="label">Altitude</span>
                <span class="value" id="hud-alt">0</span> <span class="unit">M</span>
            </div>
            <div class="instrument">
                <span class="label">Heading</span>
                <span class="value" id="hud-hdg">000</span> <span class="unit">DEG</span>
            </div>
            <div class="instrument" style="border-left-color: #ffcc00;">
                <span class="label" style="color:#ffcc00">RPM</span>
                <span class="value" id="hud-rpm">0</span> <span class="unit">x100</span>
            </div>
            <div class="instrument" style="border-left-color: #ff9900;">
                <span class="label" style="color:#ff9900">Gear</span>
                <span class="value" id="hud-gear">P</span> <span class="unit">MODE</span>
            </div>
        </div>
    
        <div id="center-warning">âš  WARNING: SLIPPAGE</div>
    </div>
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/simplex-noise/2.4.0/simplex-noise.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/DRACOLoader.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script> 

<script>
// =========================================================================================
// ** åˆå§‹ Splash Screen 3D åœºæ™¯å˜é‡ **
// =========================================================================================
let splashScene, splashCamera, splashRenderer;
let splashCarModel = null;
let splashAnimationId; // ç”¨äºå­˜å‚¨åŠ¨ç”»IDï¼Œä»¥ä¾¿åœæ­¢

// =========================================================================================
// ** ä¸»æ¸¸æˆ 3D åœºæ™¯å˜é‡ **
// =========================================================================================
let scene, renderer;
// ç§»é™¤ cameraFreeï¼Œæ–°å¢ cameraCockpit
let cameraChase, cameraCockpit, activeCamera; 
let world, vehicle, chassisBody;
let wheelMeshes = [];
let wheelGeometries = []; 
let lastTime = undefined;

// ** å…³é”®çš„çŠ¶æ€å˜é‡ **
let cityLoaded = false;
let carModelLoaded = false; 
let tireModelLoaded = false; 
let carMesh = null; // <-- æ±½è½¦çš„ THREE.Mesh è§†è§‰æ¨¡å‹
let tireMeshPrototype = null; 
let gltfLoader = null; 
let dracoLoader = null; 

const inputState = {
  keyW: false,
  keyS: false,
  keyA: false,
  keyD: false,
  keySpace: false
};

// é€Ÿåº¦è°ƒé«˜ï¼šå°†æœ€å¤§å¼•æ“åŠ›ä» 7000 æé«˜åˆ° 12000
const maxEngineForce = 12000; 
const brakeForce = 40;
// è½¬å‘çµæ•åº¦æå‡ï¼šä» 0.5 æé«˜åˆ° 0.8ï¼Œå¹¶ç¡®ä¿æ’å®š (æ–°ä¿®æ”¹)
const maxSteerVal = 0.8; // æœ€å¤§è½¬å‘è§’ï¼ˆå¼§åº¦ï¼‰

// ä»ªè¡¨ç›˜å…ƒç´ 
const speedEl = document.getElementById('hud-spd');
const altitudeEl = document.getElementById('hud-alt');
const headingEl = document.getElementById('hud-hdg');
const rpmEl = document.getElementById('hud-rpm');
const gearEl = document.getElementById('hud-gear');
const warningEl = document.getElementById('center-warning'); 

let engineForce = 0;
let steeringValue = 0;

// =========================================================================================
// ** THREE.js/GLTF Loader åˆå§‹åŒ– **
// =========================================================================================
function initLoaders() {
    dracoLoader = new THREE.DRACOLoader();
    dracoLoader.setDecoderPath('https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/libs/draco/');
    
    gltfLoader = new THREE.GLTFLoader();
    gltfLoader.setDRACOLoader(dracoLoader);
}


// =========================================================================================
// ** å¯åŠ¨ç”»é¢ 3D åœºæ™¯é€»è¾‘ **
// =========================================================================================
function initSplashThree() {
    const container = document.getElementById('splash-three-container');
    const width = container.clientWidth;
    const height = container.clientHeight;

    splashScene = new THREE.Scene();
    // ä½¿ç”¨é€æ˜èƒŒæ™¯
    splashRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    splashRenderer.setClearColor(0x000000, 0); // é€æ˜èƒŒæ™¯
    splashRenderer.setSize(width, height);
    container.appendChild(splashRenderer.domElement);

    splashCamera = new THREE.PerspectiveCamera(75, width / height, 0.1, 100);
    splashCamera.position.set(0, 1, 3);
    splashCamera.lookAt(0, 0, 0);

    // ç¯å…‰
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.9);
    splashScene.add(ambientLight);
    const pointLight = new THREE.PointLight(0xffffff, 1.5);
    pointLight.position.set(5, 5, 5);
    splashScene.add(pointLight);
    const pointLight2 = new THREE.PointLight(0xffffff, 0.5);
    pointLight2.position.set(-5, 0, -5);
    splashScene.add(pointLight2);
}

function loadSplashCarModel() {
    if (!gltfLoader) return;
    
    // åŠ è½½å’Œä¸»åœºæ™¯ç›¸åŒçš„æ±½è½¦æ¨¡å‹
    gltfLoader.load(
        'car1.glb', 
        (gltf) => {
            splashCarModel = gltf.scene;
            // è°ƒæ•´å¯åŠ¨ç”»é¢æ¨¡å‹çš„ç¼©æ”¾ (Scale è°ƒå¤§)
            splashCarModel.scale.set(1.2, 1.2, 1.2); 
            splashCarModel.rotation.y = Math.PI; 
            splashCarModel.position.y = -1; // è°ƒæ•´ä½ç½®ä½¿å…¶åœ¨è§†é‡ä¸­å¤®
            
            splashScene.add(splashCarModel);
            
            // æ¨¡å‹åŠ è½½æˆåŠŸåå¼€å§‹åŠ¨ç”»
            splashAnimate(); 
        },
        undefined, // onProgress
        (error) => {
            console.error('Failed to load splash car model', error);
        }
    );
}

function splashAnimate() {
    splashAnimationId = requestAnimationFrame(splashAnimate);

    if (splashCarModel) {
        // è®©æ±½è½¦æ¨¡å‹å›´ç»• Y è½´æ—‹è½¬
        splashCarModel.rotation.y += 0.005; 
    }

    if (splashRenderer && splashScene && splashCamera) {
        splashRenderer.render(splashScene, splashCamera);
    }
}
// =========================================================================================
// ** æ¸¸æˆå¯åŠ¨å’ŒåŠ è½½é€»è¾‘ **
// =========================================================================================
function checkGameReady() {
    if (cityLoaded && carModelLoaded && tireModelLoaded) {
        // åœæ­¢å¯åŠ¨ç”»é¢çš„åŠ¨ç”»
        cancelAnimationFrame(splashAnimationId);
        
        // å…³é—­åŠ è½½ç•Œé¢ï¼Œæ˜¾ç¤º HUD
        document.getElementById('loading-screen').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('hud-layer').style.display = 'flex'; 
        }, 500);

        // æ‰€æœ‰ç»„ä»¶éƒ½å‡†å¤‡å¥½äº†ï¼Œæ‰åˆå§‹åŒ–è½¦è¾†å’ŒåŠ¨ç”»
        initVehicle(); 
        requestAnimationFrame(animate);
    }
}

// å¤„ç†å¯åŠ¨ç”»é¢åˆ°åŠ è½½ç”»é¢çš„è¿‡æ¸¡
function startGame() {
    // 1. éšè—å¯åŠ¨ç”»é¢
    document.getElementById('splash').style.display = 'none';
    // 2. æ˜¾ç¤ºåŠ è½½ç”»é¢
    document.getElementById('loading-screen').style.display = 'flex'; 

    // 3. å¼€å§‹æ¸¸æˆåˆå§‹åŒ–å’Œèµ„äº§åŠ è½½
    setupGame();
}
window.startGame = startGame; 

function setupGame() {
    initThree();
    initCannon();
    initGround();
    initCameraAndLights(); 
    
    // å¼€å§‹åŠ è½½æ±½è½¦æ¨¡å‹ã€è½®èƒæ¨¡å‹å’ŒåŸå¸‚æ¨¡å‹
    loadCarModel(); 
    loadTireModel(); 
    loadCity();
}

// =========================================================================================
// ** æ¨¡å‹åŠ è½½å‡½æ•° **
// =========================================================================================
/**************** æ±½è½¦ 3D æ¨¡å‹åŠ è½½ ****************/
function loadCarModel() {
    if (!gltfLoader) {
        console.error("GLTFLoader is not initialized!");
        return;
    }

    gltfLoader.load(
        'car1.glb', // æ‚¨çš„æ±½è½¦æ¨¡å‹è·¯å¾„
        (gltf) => {
            carMesh = gltf.scene;
            // è½¦å­ scale è°ƒé«˜ (Scale è°ƒå¤§)
            carMesh.scale.set(1.2, 1.2, 1.2); 
            carMesh.rotation.y = Math.PI; 
            // åˆå§‹ä½ç½®è°ƒæ•´ï¼Œä½¿å…¶åœ¨ç‰©ç†åº•ç›˜ä¸Šæ–¹
            carMesh.position.y = -0.5; 
            
            carMesh.traverse((node) => {
                if (node.isMesh) {
                    node.castShadow = true;
                }
            });
            // ç«‹å³æ·»åŠ åˆ°åœºæ™¯ï¼Œä»¥ä¾¿åœ¨ initVehicle ä¸æ·»åŠ åº•ç›˜æ—¶ä¹Ÿèƒ½æ˜¾ç¤º
            scene.add(carMesh); 
            
            carModelLoaded = true; 
            checkGameReady();      
        },
        (xhr) => {
        },
        (error) => {
            console.error('Failed to load car1.glb', error);
            carMesh = null; 
            carModelLoaded = true;
            checkGameReady();
        }
    );
}

/**************** è½®èƒ 3D æ¨¡å‹åŠ è½½ ****************/
function loadTireModel() {
    if (!gltfLoader) {
        console.error("GLTFLoader is not initialized!");
        return;
    }

    gltfLoader.load(
        'tire1.glb', // è½®èƒæ¨¡å‹è·¯å¾„
        (gltf) => {
            tireMeshPrototype = gltf.scene;
            // è°ƒæ•´è½®èƒåŸå‹æ¨¡å‹çš„å¤§å°ã€æ—‹è½¬ç­‰ä»¥åŒ¹é…ç‰©ç†å°ºå¯¸
            tireMeshPrototype.scale.set(0.5, 0.5, 0.5); 
            tireMeshPrototype.rotation.x = Math.PI / 2; // é»˜è®¤ Three.js è½®å­å¯èƒ½éœ€è¦æ—‹è½¬
            
            tireMeshPrototype.traverse((node) => {
                if (node.isMesh) {
                    node.castShadow = true;
                }
            });
            console.log("Tire model loaded successfully: tire1.glb");

            tireModelLoaded = true;
            checkGameReady();
        },
        (xhr) => {
        },
        (error) => {
            console.error('Failed to load tire1.glb', error);
            tireMeshPrototype = null;
            tireModelLoaded = true;
            checkGameReady();
        }
    );
}

/**************** åŸå¸‚ glb ****************/
function loadCity() {
  const progressFill = document.getElementById('loading-progress-fill');
  const loadingStatus = document.getElementById('loading-status');

  if (!gltfLoader) {
    console.error("GLTFLoader is not initialized!");
    return;
  }
    
  gltfLoader.load(
    'city.glb', 
    (gltf) => {
      const city = gltf.scene;
      city.traverse((node) => {
        if (node.isMesh) {
          node.castShadow = true;
          node.receiveShadow = true;
        }
      });
      scene.add(city);
      city.scale.set (4, 4, 4)
      
      cityLoaded = true; 
      checkGameReady();
    },
    (xhr) => {
      if (xhr.total) {
        const percent = Math.floor(xhr.loaded / xhr.total * 100);
        progressFill.style.width = percent + '%';
        // ç¡®ä¿ loadingStatus æ›´æ–°äº†
        loadingStatus.innerText = `(${percent}%) Loading City Assets...`; 
      }
    },
    (err) => {
      console.error('Failed to load city.glb', err);
      cityLoaded = true;
      checkGameReady();
    }
  );
}


// =========================================================================================
// ** THREE.js/Cannon.js åŸºç¡€è®¾ç½® **
// =========================================================================================
function initThree() {
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x87CEEB);

  renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setPixelRatio(window.devicePixelRatio || 1);
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.shadowMap.enabled = true;
  renderer.shadowMap.type = THREE.BasicShadowMap; 
  
  // ç¡®ä¿ä¸»æ¸¸æˆç”»å¸ƒé™„åŠ åˆ° body
  document.body.appendChild(renderer.domElement); 
}

function initCannon() {
  world = new CANNON.World();
  world.gravity.set(0, -9.82, 0);
  world.broadphase = new CANNON.SAPBroadphase(world);
  world.allowSleep = true;

  const defaultMaterial = new CANNON.Material('default');
  const contactMaterial = new CANNON.ContactMaterial(
    defaultMaterial,
    defaultMaterial,
    {
      friction: 0.6,
      restitution: 0.0
    }
  );
  world.defaultContactMaterial = contactMaterial;
  world.addContactMaterial(contactMaterial);
}

/**************** åœ°é¢ ****************/
function initGround() {
  const groundShape = new CANNON.Plane();
  const groundBody = new CANNON.Body({
    mass: 0,
    material: world.defaultContactMaterial.material
  });
  groundBody.addShape(groundShape);
  groundBody.quaternion.setFromEuler(-Math.PI / 2, 0, 0);
  world.addBody(groundBody);

  const groundGeo = new THREE.PlaneGeometry(500, 500, 10, 10);
  const groundMat = new THREE.MeshPhongMaterial({ color: 0x444444 });
  const groundMesh = new THREE.Mesh(groundGeo, groundMat);
  groundMesh.rotation.x = -Math.PI / 2;
  groundMesh.position.y = -0.05;
  groundMesh.receiveShadow = true;
  scene.add(groundMesh);
}

/**************** ç›¸æœºå’Œç¯å…‰ ****************/
function initCameraAndLights() {
  cameraChase = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
  // ç§»é™¤ cameraFreeï¼Œæ–°å¢ cameraCockpit
  cameraCockpit = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 1000); 
  
  // åˆå§‹è®¾ç½®
  activeCamera = cameraChase;
  
  const hemiLight = new THREE.HemisphereLight(0xffffff, 0x3b4c5a, 0.8);
  scene.add(hemiLight);

  const dirLight = new THREE.DirectionalLight(0xfff0dd, 1.0);
  dirLight.position.set(50, 100, 50);
  dirLight.castShadow = true;
  dirLight.shadow.mapSize.width = 4096;
  dirLight.shadow.mapSize.height = 4096;
  dirLight.shadow.camera.near = 0.5;
  dirLight.shadow.camera.far = 500;
  dirLight.shadow.camera.left = -100;
  dirLight.shadow.camera.right = 100;
  dirLight.shadow.camera.top = 100;
  dirLight.shadow.camera.bottom = -100;
  scene.add(dirLight);
}

/**************** è½¦è¾†æ¨¡å‹å’Œç‰©ç†è®¾ç½® ****************/
function initVehicle() {
  // ç‰©ç†ç¢°æ’ä½“ä¿æŒä¸å˜ (2x1x4 ç±³)
  const chassisShape = new CANNON.Box(new CANNON.Vec3(1, 0.5, 2)); 
  chassisBody = new CANNON.Body({
    mass: 1500,
    shape: chassisShape,
    // ä¿æŒé‡å¿ƒé«˜åº¦ä¸º 1.0ï¼Œé˜²æ­¢è¿‡åº¦ä¾§ç¿»
    position: new CANNON.Vec3(0, 1.0, 0) 
  });
  chassisBody.angularDamping = 0.8;
  chassisBody.linearDamping = 0.1;
  world.addBody(chassisBody);
  
  // è§†è§‰æ¨¡å‹ (carMesh) åœ¨ loadCarModel ä¸­å·²æ·»åŠ åˆ°åœºæ™¯å¹¶å•ç‹¬ç®¡ç† (åº•ç›˜ä¸å¯è§)

  vehicle = new CANNON.RaycastVehicle({
    chassisBody: chassisBody,
    indexRightAxis: 0,
    indexUpAxis: 1,
    indexForwardAxis: 2
  });

  const axleWidth = 1.0;
  const wheelBase = 1.5;

  function makeWheelOptions(x, y, z) {
    return {
      radius: 0.5, // ç‰©ç†åŠå¾„
      directionLocal: new CANNON.Vec3(0, -1, 0),
      suspensionStiffness: 30,
      suspensionRestLength: 0.3,
      // é™ä½æ‘©æ“¦åŠ›ï¼Œå¢åŠ æ¼‚ç§»å’Œä¾§æ»‘æ„Ÿ (æ–°ä¿®æ”¹)
      frictionSlip: 3, 
      dampingRelaxation: 2.3,
      dampingCompression: 4.4,
      maxSuspensionForce: 100000,
      // ä¿æŒè¾ƒä½çš„ rollInfluenceï¼Œè®©é‡å¿ƒå˜åŒ–ä¸ºä¸»å¯¼
      rollInfluence: 0.01, 
      maxSuspensionTravel: 0.3,
      customSlidingRotationalSpeed: -30,
      useCustomSlidingRotationalSpeed: true,
      axleLocal: new CANNON.Vec3(1, 0, 0),
      chassisConnectionPointLocal: new CANNON.Vec3(x, y, z)
    };
  }

  // å››è½®å¯¹ç§°å¸ƒå±€
  vehicle.addWheel(makeWheelOptions(-axleWidth, 0, wheelBase)); // 0: FL (å‰å·¦)
  vehicle.addWheel(makeWheelOptions( axleWidth, 0, wheelBase)); // 1: FR (å‰å³)
  vehicle.addWheel(makeWheelOptions(-axleWidth, 0, -wheelBase)); // 2: RL (åå·¦)
  vehicle.addWheel(makeWheelOptions( axleWidth, 0, -wheelBase)); // 3: RR (åå³)

  vehicle.addToWorld(world);

  // åˆ›å»ºè½®å­ mesh (ç§»é™¤ scene.add(wheelMesh) ä½¿è½®å­ä¸å¯è§)
  wheelMeshes = [];
  
  if (tireMeshPrototype) {
        // ä½¿ç”¨åŠ è½½çš„ tire1.glb æ¨¡å‹ä½œä¸ºè½®å­
        for (let i = 0; i < vehicle.wheelInfos.length; i++) {
            const wheelMesh = tireMeshPrototype.clone();
            // ç§»é™¤ scene.add(wheelMesh); ä½¿è½®å­ä¸å¯è§ (å·²å®ç°)
            wheelMeshes.push(wheelMesh);
        }
  } else {
        // å›é€€åˆ°é»˜è®¤åœ†æŸ±ä½“è½®å­
        console.warn("Tire model not loaded, using fallback cylinder mesh.");
        const wheelMat = new THREE.MeshPhongMaterial({ color: 0x111111 });
        for (let i = 0; i < vehicle.wheelInfos.length; i++) {
            const wheel = vehicle.wheelInfos[i];
            const cylinderGeometry = new THREE.CylinderGeometry(wheel.radius, wheel.radius, 0.2, 32);
            cylinderGeometry.rotateZ(Math.PI / 2); // æ—‹è½¬ä»¥åŒ¹é… CANNON.js è½®å­æ–¹å‘
            const wheelMesh = new THREE.Mesh(cylinderGeometry, wheelMat);
            // ç§»é™¤ scene.add(wheelMesh); ä½¿è½®å­ä¸å¯è§ (å·²å®ç°)
            wheelMeshes.push(wheelMesh);
        }
  }
}

// =========================================================================================
// ** æ¸¸æˆå¾ªç¯é€»è¾‘ **
// =========================================================================================

/**************** é”®ç›˜æ§åˆ¶ ****************/
window.addEventListener('keydown', (event) => {
  switch (event.key.toLowerCase()) {
    case 'w':
      inputState.keyW = true;
      break;
    case 's':
      inputState.keyS = true;
      break;
    case 'a':
      inputState.keyA = true;
      break;
    case 'd':
      inputState.keyD = true;
      break;
    case ' ':
      inputState.keySpace = true;
      event.preventDefault(); // é˜»æ­¢ç©ºæ ¼é”®æ»šåŠ¨é¡µé¢
      break;
    case 'v':
      toggleCamera();
      break;
  }
});

window.addEventListener('keyup', (event) => {
  switch (event.key.toLowerCase()) {
    case 'w':
      inputState.keyW = false;
      break;
    case 's':
      inputState.keyS = false;
      break;
    case 'a':
      inputState.keyA = false;
      break;
    case 'd':
      inputState.keyD = false;
      break;
    case ' ':
      inputState.keySpace = false;
      break;
  }
});

function toggleCamera() {
  if (activeCamera === cameraChase) {
    activeCamera = cameraCockpit; // åˆ‡æ¢åˆ°é©¾é©¶èˆ±è§†è§’
  } else {
    activeCamera = cameraChase; // åˆ‡æ¢åˆ°è¿½é€è§†è§’
  }
}

function updateControls() {
  if (!chassisBody) return; 

  // é‡ç½®
  engineForce = 0;
  steeringValue = 0;
  let brake = 0; // W/S äº§ç”Ÿçš„æ­£å¸¸åˆ¹è½¦åŠ›
  
  const v = chassisBody.velocity;
  const currentSpeed = v.length() * 3.6; // m/s to km/h
  // ä½¿ç”¨ Three.js å‘é‡æ¥è®¡ç®—æ–¹å‘
  const chassisQuaternion = new THREE.Quaternion(chassisBody.quaternion.x, chassisBody.quaternion.y, chassisBody.quaternion.z, chassisBody.quaternion.w);
  const forwardVector = new THREE.Vector3(0, 0, 1).applyQuaternion(chassisQuaternion);
  const velocityVector = new THREE.Vector3(v.x, v.y, v.z);
  const isMovingForward = velocityVector.dot(forwardVector) > 0.5;
  const isMovingBackward = velocityVector.dot(forwardVector) < -0.5;

  // æ ¸å¿ƒä¿®å¤ï¼šç§»é™¤é€Ÿåº¦å¯¹è½¬å‘è§’çš„åŠ¨æ€å½±å“ï¼Œå§‹ç»ˆä½¿ç”¨æœ€å¤§è½¬å‘è§’ (maxSteerVal)
  // let currentMaxSteer = maxSteerVal;
  // if (currentSpeed > 60) {
  //   currentMaxSteer *= 0.3;
  // } else if (currentSpeed > 30) {
  //   currentMaxSteer *= 0.6;
  // }
  // if (inputState.keyA) steeringValue = currentMaxSteer;
  // else if (inputState.keyD) steeringValue = -currentMaxSteer;
  
  if (inputState.keyA) steeringValue = maxSteerVal;
  else if (inputState.keyD) steeringValue = -maxSteerVal;

  if (inputState.keyW) {
    if (isMovingBackward) {
      brake = maxEngineForce * 0.5;
    } else {
      // W (åŠ é€Ÿ) é©±åŠ¨åè½®
      engineForce = -maxEngineForce;
      gearEl.textContent = 'D';
    }
  } else if (inputState.keyS) {
    if (isMovingForward) {
      brake = maxEngineForce * 0.5;
    } else {
      // S (å€’è½¦) é©±åŠ¨åè½®
      engineForce = maxEngineForce * 0.5;
      gearEl.textContent = 'R';
    }
  } else if (!inputState.keySpace) { 
    // è‡ªåŠ¨è½»å¾®åˆ¹è½¦/é©»è½¦ (æ‰‹åˆ¹æŒ‰ä¸‹æ—¶ï¼Œä¸åˆ¤æ–­ P/N æ¡£)
    if (currentSpeed < 1) {
      gearEl.textContent = 'P';
    } else {
      gearEl.textContent = 'N';
    }
  }

  // è½¬å‘åº”ç”¨äºå‰è½®
  vehicle.setSteeringValue(steeringValue, 0); // FL
  vehicle.setSteeringValue(steeringValue, 1); // FR

  // é©±åŠ¨åŠ›åº”ç”¨äºåè½®
  vehicle.applyEngineForce(engineForce, 2); // RL
  vehicle.applyEngineForce(engineForce, 3); // RR

  // === ç»Ÿä¸€åº”ç”¨åˆ¹è½¦é€»è¾‘ (W/S åˆ¹è½¦å’Œ æ‰‹åˆ¹) ===
  let finalBrakeFL = brake;
  let finalBrakeFR = brake;
  let finalBrakeRL = brake;
  let finalBrakeRR = brake;

  // æ‰‹åˆ¹é€»è¾‘ï¼šä»…åº”ç”¨äºåè½® 
  if (inputState.keySpace) {
      // æ‰‹åˆ¹ï¼šå¯¹åè½®æ–½åŠ æé«˜åˆ¹è½¦åŠ›ï¼ˆæ‰‹åˆ¹ï¼‰ï¼Œå‰è½®åªå— W/S æ­£å¸¸åˆ¹è½¦åŠ›çš„å½±å“
      const handbrakeStrength = maxEngineForce * 0.8; 
      finalBrakeRL = handbrakeStrength; 
      finalBrakeRR = handbrakeStrength; 
      gearEl.textContent = 'E'; // E for Emergency/Handbrake
  }

  // æœ€ç»ˆåˆ¹è½¦åº”ç”¨
  vehicle.setBrake(finalBrakeFL, 0); // FL
  vehicle.setBrake(finalBrakeFR, 1); // FR
  vehicle.setBrake(finalBrakeRL, 2); // RL
  vehicle.setBrake(finalBrakeRR, 3); // RR

  // ä¼˜åŒ–ï¼šå¦‚æœæ‰€æœ‰åˆ¹è½¦åŠ›ä¸ºé›¶ï¼Œä¸”æ²¡æœ‰æŒ‰æ‰‹åˆ¹ï¼Œåˆ™æ˜¾å¼ç§»é™¤åˆ¹è½¦ï¼Œç¡®ä¿ä¸ç•™æ®‹ä½™åŠ›ã€‚
  if (finalBrakeFL === 0 && finalBrakeRL === 0 && !inputState.keySpace) {
    vehicle.setBrake(0, 0);
    vehicle.setBrake(0, 1);
    vehicle.setBrake(0, 2);
    vehicle.setBrake(0, 3);
  }
}

/**************** æ‘„åƒæœº ****************/
function updateCamera() {
  if (!chassisBody) return;
  const chassisPos = chassisBody.position;
  const q = chassisBody.quaternion;

  if (activeCamera === cameraChase) {
    // è¿½é€è§†è§’: è°ƒæ•´ä¸ºæ›´é è¿‘è½¦èº«
    const offset = new THREE.Vector3(0, 3, -7); 
    offset.applyQuaternion(q);
    offset.add(chassisPos);

    cameraChase.position.lerp(offset, 0.1);
    cameraChase.lookAt(chassisPos.x, chassisPos.y + 1, chassisPos.z);
  } else if (activeCamera === cameraCockpit) {
    // é©¾é©¶èˆ±è§†è§’: ä¿®æ­£ä½ç½®å’Œæ–¹å‘
    const offset = new THREE.Vector3(0, 0.8, 1.5); 
    offset.applyQuaternion(q);
    offset.add(chassisPos);

    cameraCockpit.position.copy(offset);
    
    // è®¾ç½®æ—‹è½¬ä¸åº•ç›˜ä¸€è‡´
    cameraCockpit.quaternion.copy(q);
    
    // æ–°å¢ï¼šå°†é©¾é©¶èˆ±è§†è§’å›´ç»• Y è½´æ—‹è½¬ 180 åº¦ (Ï€ å¼§åº¦)
    const rotation180 = new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0, 1, 0), Math.PI);
    cameraCockpit.quaternion.multiply(rotation180);
  }
}

function updateWheelMeshes() {
  for (let i = 0; i < vehicle.wheelInfos.length; i++) {
    vehicle.updateWheelTransform(i);
    const t = vehicle.wheelInfos[i].worldTransform;
    // å°½ç®¡æˆ‘ä»¬ä¸å†æ¸²æŸ“è½®å­ Meshï¼Œä½†ä¸ºäº†ä¸€è‡´æ€§ï¼Œä»æ›´æ–°å®ƒä»¬çš„å˜æ¢
    if (wheelMeshes[i]) { 
        wheelMeshes[i].position.copy(t.position);
        wheelMeshes[i].quaternion.copy(t.quaternion);
    }
  }
}

// åªè´Ÿè´£æ›´æ–°è§†è§‰ carMesh çš„ä½ç½®
function updateCarMesh() { 
    if (chassisBody && carMesh) {
        // 1. å°† Three.js Mesh çš„ä½ç½®è®¾ç½®ä¸º Cannon.js Body çš„ä½ç½®
        carMesh.position.copy(chassisBody.position);
        // 2. å°† Three.js Mesh çš„æ—‹è½¬è®¾ç½®ä¸º Cannon.js Body çš„æ—‹è½¬
        carMesh.quaternion.copy(chassisBody.quaternion);
    }
}

/**************** HUD ****************/
function updateHUD() {
  if (!chassisBody) return;

  const v = chassisBody.velocity;
  const speed = v.length() * 3.6; // m/s to km/h
  speedEl.textContent = speed.toFixed(0);

  altitudeEl.textContent = chassisBody.position.y.toFixed(0);

  const forward = new THREE.Vector3(0, 0, 1);
  forward.applyQuaternion(chassisBody.quaternion);
  const heading = Math.atan2(forward.x, forward.z) * 180 / Math.PI;
  let h = (heading + 360) % 360;
  headingEl.textContent = h.toFixed(0).padStart(3, '0');

  // æ¨¡æ‹Ÿ RPM (ç³»æ•°ä» 1.5 æé«˜åˆ° 2.0ï¼Œä»¥åŒ¹é…æ›´é«˜çš„é€Ÿåº¦)
  const rpm = Math.min(75, Math.floor(speed * 2.0));
  rpmEl.textContent = rpm;

  // é€Ÿåº¦è¶…è¿‡ 100km/h æ˜¾ç¤ºè­¦å‘Š
  warningEl.style.display = speed > 100 ? 'block' : 'none';
  warningEl.innerText = "âš  WARNING: SLIPPAGE"; 
}

/**************** åŠ¨ç”» ****************/
function animate(time) {
  requestAnimationFrame(animate);
  // ä»…åœ¨ chassisBody å­˜åœ¨æ—¶æ‰è¿è¡Œ physics å’Œ controls
  if (!chassisBody || !world) return; 

  const fixedTimeStep = 1 / 60;
  const maxSubSteps = 1; 

  if (lastTime !== undefined) {
    const dt = (time - lastTime) / 1000;
    world.step(fixedTimeStep, dt, maxSubSteps);
  } else {
    world.step(fixedTimeStep);
  }
  lastTime = time;

  updateControls();
  updateCarMesh(); // è°ƒç”¨æ›´æ–° carMesh çš„æ–°å‡½æ•°
  updateWheelMeshes();
  updateCamera();
  updateHUD();

  renderer.render(scene, activeCamera);
}

// =========================================================================================
// ** å¯åŠ¨é€»è¾‘ **
// =========================================================================================
window.addEventListener('resize', () => {
  // ä¸»æ¸¸æˆåœºæ™¯çš„ resize é€»è¾‘
  if (renderer && cameraChase && cameraCockpit) { 
    renderer.setSize(window.innerWidth, window.innerHeight);
    
    const aspect = window.innerWidth / window.innerHeight;
    cameraChase.aspect = aspect;
    cameraChase.updateProjectionMatrix();
    cameraCockpit.aspect = aspect; 
    cameraCockpit.updateProjectionMatrix();
  }
  // å¯åŠ¨ç”»é¢çš„ resize é€»è¾‘
  if (splashRenderer && splashCamera) {
    const container = document.getElementById('splash-three-container');
    const width = container.clientWidth;
    const height = container.clientHeight;
    splashRenderer.setSize(width, height);
    splashCamera.aspect = width / height;
    splashCamera.updateProjectionMatrix();
  }
});

// åœ¨é¡µé¢åŠ è½½åæ‰§è¡Œï¼šåˆå§‹åŒ–åŠ è½½å™¨ã€å¯åŠ¨ç”»é¢ 3D åœºæ™¯å¹¶åŠ è½½æ¨¡å‹
document.addEventListener('DOMContentLoaded', () => {
    initLoaders();
    initSplashThree();
    loadSplashCarModel(); // åŠ è½½å¹¶å¼€å§‹æ—‹è½¬åŠ¨ç”»
});

</script>
</body>
</html>