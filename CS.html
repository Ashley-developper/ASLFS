<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASL Car Simulator</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #000;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            user-select: none;
        }

        #hud-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 25px;
            box-sizing: border-box;
            z-index: 10;
        }

        .hud-top-left {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .instrument {
            background: rgba(10, 20, 30, 0.75);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-left: 4px solid #00aaff;
            backdrop-filter: blur(8px);
            padding: 10px 18px;
            color: #eee;
            min-width: 100px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            border-radius: 4px;
        }

        .label {
            font-size: 10px;
            color: #88ccff;
            font-weight: 600;
            letter-spacing: 1px;
            margin-bottom: 4px;
            display:block;
            text-transform: uppercase;
        }

        .value {
            font-size: 26px;
            font-weight: 700;
            font-family: 'Consolas', monospace;
            letter-spacing: -1px;
        }

        .unit {
            font-size: 12px;
            color: #888;
            margin-left: 4px;
            font-weight: 400;
        }

        /* 启动画面 */
        #splash {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0093E9 0%, #80D0C7 100%);
            z-index: 999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        }

        #splash-three-container {
            width: 300px;
            height: 150px;
            margin-bottom: 20px;
            position: relative;
        }

        h1 {
            font-size: 32px;
            margin: 0;
            font-weight: 400;
            letter-spacing: 5px;
            text-transform: uppercase;
            color: #fff;
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        }

        #plane-chooser-title {
            font-size: 20px;
            margin-bottom: 20px;
            font-weight: 600;
            color: #f0f0f0;
            letter-spacing: 3px;
        }

        #plane-info-display {
            text-align: center;
            margin-top: 15px;
            padding: 15px 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            min-width: 450px;
        }

        .plane-title {
            font-size: 18px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 10px;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px 20px;
            font-size: 13px;
            color: #c0e0f0;
        }

        .stat-value {
            font-family: 'Consolas', monospace;
            font-weight: bold;
            color: #80D0C7;
            margin-left: 5px;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: auto auto;
            gap: 10px 20px;
            margin-top: 20px;
            text-align: left;
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            font-size: 14px;
        }

        .key-box {
            font-family: 'Consolas', monospace;
            color: #80D0C7;
            font-weight: bold;
            margin-right: 8px;
            background: rgba(255, 255, 255, 0.15);
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #80D0C7;
        }

        button#start-button {
            margin-top: 40px;
            padding: 14px 50px;
            font-size: 16px;
            font-weight: 700;
            border: none;
            background: #0093E9;
            color: #fff;
            cursor: pointer;
            letter-spacing: 2px;
            transition: all 0.3s;
            text-transform: uppercase;
            border-radius: 30px;
            box-shadow: 0 6px 20px rgba(0, 147, 233, 0.6);
        }

        button#start-button:hover {
            background: #80D0C7;
            color: #000;
            box-shadow: 0 6px 25px rgba(128, 208, 199, 0.8);
        }

        button#start-button:active {
            transform: translateY(2px);
            box-shadow: 0 3px 10px rgba(0, 147, 233, 0.6);
        }

        /* Loading 界面样式 */
        #loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
        }

        #loading-progress-bar {
            width: 300px;
            height: 10px;
            margin-top: 20px;
            background: #555;
            border-radius: 5px;
            overflow: hidden;
        }

        #loading-progress-fill {
            height: 100%;
            width: 0%;
            background: #00aaff;
            transition: width 0.3s;
        }

        .hud-bottom {
            display: flex;
            justify-content: flex-end;
            align-items: flex-end;
            gap: 20px;
        }

        .hud-bottom-right {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }
    </style>
</head>
<body>

<div id="splash">
    <h1>ASL <b>CAR SIMULATOR</b></h1>
    <p id="plane-chooser-title">CITY DRIVE MODE</p>

    <div id="splash-three-container"></div>

    <div id="plane-info-display" style="min-width:350px;">
        <p class="plane-title" id="plane-name">SPORTS CAR R‑1</p>
        <div class="stats-grid">
            <div>Mass: <span id="stat-mass" class="stat-value">1500</span> KG</div>
            <div>Power: <span id="stat-thrust" class="stat-value">300</span> HP</div>
            <div>Torque: <span id="stat-lift" class="stat-value">900</span> Nm</div>
            <div>Redline: <span id="stat-height" class="stat-value">7500</span> RPM</div>
        </div>
    </div>

    <div class="controls-grid">
        <div><span class="key-box">W</span> Accelerate</div>
        <div><span class="key-box">S</span> Brake / Reverse</div>
        <div><span class="key-box">A / D</span> Steer Left / Right</div>
        <div><span class="key-box">SPACE</span> Handbrake (Rear-wheel drift)</div>
        <div><span class="key-box">V</span> Change camera view</div>
    </div>

    <div style="margin-top:20px; color:#c0e0f0; font-size:13px; opacity: 0.8;">
        © 2025 Zhanyi Zhou (ASL) All rights reserved
    </div>

    <button id="start-button" onclick="startGame()">START DRIVING</button>
</div>

<div id="loading-screen">
    <p>Loading City and Assets...</p>
    <div id="loading-progress-bar">
        <div id="loading-progress-fill"></div>
    </div>
    <p id="loading-status" style="margin-top:10px; font-size:14px;">(0%)</p>
</div>

<div id="hud-layer" style="display:none;">
    <div class="hud-top-left">
        <div class="instrument">
            <span class="label">Speed</span>
            <span class="value" id="hud-spd">0</span> <span class="unit">KM/H</span>
        </div>
        <div class="instrument">
            <span class="label">Altitude</span>
            <span class="value" id="hud-alt">0</span> <span class="unit">M</span>
        </div>
        <div class="instrument">
            <span class="label">Heading</span>
            <span class="value" id="hud-hdg">000</span> <span class="unit">DEG</span>
        </div>
        <div class="instrument" style="border-left-color: #ffcc00;">
            <span class="label" style="color:#ffcc00">RPM</span>
            <span class="value" id="hud-rpm">0</span> <span class="unit">x100</span>
        </div>
        <div class="instrument" style="border-left-color: #ff9900;">
            <span class="label" style="color:#ff9900">Gear</span>
            <span class="value" id="hud-gear">P</span> <span class="unit">MODE</span>
        </div>
        <div class="instrument" style="border-left-color: #ff6699;">
            <span class="label" style="color:#ff6699">Steer</span>
            <span class="value" id="hud-steer">0°</span> <span class="unit">ANGLE</span>
        </div>
    </div>

    <div class="hud-bottom">
        <div class="hud-bottom-right">
            <div class="instrument" style="border-left-color: #00ff00;">
                <span class="label" style="color:#00ff00">Throttle</span>
                <span class="value" id="hud-throttle">0%</span>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/DRACOLoader.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>

<script>
// ============== 全局变量 ==============
let splashScene, splashCamera, splashRenderer;
let splashCarModel = null, splashAnimationId;

let scene, renderer;
let cameraChase, cameraCockpit, activeCamera;
let world, vehicle, chassisBody;
let wheelMeshes = [];
let lastTime;

let cityLoaded = false;
let carModelLoaded = false;
let tireModelLoaded = false;
let carMesh = null;
let tireMeshPrototype = null;
let gltfLoader = null;
let dracoLoader = null;

const inputState = {
    keyW: false,
    keyS: false,
    keyA: false,
    keyD: false,
    keySpace: false
};

// 提速 + 线性油门
const maxEngineForce = 22000;   // 提高最高速度
const brakeForce = 40;
const maxSteerVal = 1.2;

// 线性油门变量
let targetThrottle = 0;      // -1 ~ 1
let currentThrottle = 0;     // -1 ~ 1
const throttleStep = 1.0;    // 每秒变化量，可调

// HUD 元素
const speedEl = document.getElementById('hud-spd');
const altitudeEl = document.getElementById('hud-alt');
const headingEl = document.getElementById('hud-hdg');
const rpmEl = document.getElementById('hud-rpm');
const gearEl = document.getElementById('hud-gear');
const steerEl = document.getElementById('hud-steer');
const throttleEl = document.getElementById('hud-throttle');

let engineForce = 0;
let steeringValue = 0;

// ============== Loader 初始化 ==============
function initLoaders() {
    dracoLoader = new THREE.DRACOLoader();
    dracoLoader.setDecoderPath('https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/libs/draco/');

    gltfLoader = new THREE.GLTFLoader();
    gltfLoader.setDRACOLoader(dracoLoader);
}

// ============== 启动画面 3D ==============
function initSplashThree() {
    const container = document.getElementById('splash-three-container');
    const width = container.clientWidth;
    const height = container.clientHeight;

    splashScene = new THREE.Scene();
    splashRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    splashRenderer.setClearColor(0x000000, 0);
    splashRenderer.setSize(width, height);
    container.appendChild(splashRenderer.domElement);

    splashCamera = new THREE.PerspectiveCamera(75, width / height, 0.1, 100);
    splashCamera.position.set(0, 1, 3);
    splashCamera.lookAt(0, 0, 0);

    const ambientLight = new THREE.AmbientLight(0xffffff, 0.9);
    splashScene.add(ambientLight);
    const pointLight = new THREE.PointLight(0xffffff, 1.5);
    pointLight.position.set(5, 5, 5);
    splashScene.add(pointLight);
}

function loadSplashCarModel() {
    if (!gltfLoader) return;

    gltfLoader.load(
        'car1.glb',
        (gltf) => {
            splashCarModel = gltf.scene;
            splashCarModel.scale.set(2.0, 2.0, 2.0);  // 放大
            splashCarModel.rotation.y = Math.PI;
            splashCarModel.position.y = -1;
            splashScene.add(splashCarModel);
            splashAnimate();
        }
    );
}

function splashAnimate() {
    splashAnimationId = requestAnimationFrame(splashAnimate);
    if (splashCarModel) {
        splashCarModel.rotation.y += 0.005;
    }
    if (splashRenderer && splashScene && splashCamera) {
        splashRenderer.render(splashScene, splashCamera);
    }
}

// ============== 启动与加载 ==============
function checkGameReady() {
    if (cityLoaded && carModelLoaded && tireModelLoaded) {
        cancelAnimationFrame(splashAnimationId);

        document.getElementById('loading-screen').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('hud-layer').style.display = 'flex';
        }, 500);

        initVehicle();
        requestAnimationFrame(animate);
    }
}

function startGame() {
    document.getElementById('splash').style.display = 'none';
    document.getElementById('loading-screen').style.display = 'flex';
    setupGame();
}
window.startGame = startGame;

function setupGame() {
    initThree();
    initCannon();
    initGround();
    initCameraAndLights();
    loadCarModel();
    loadTireModel();
    loadCity();
}

// ============== 模型加载 ==============
function loadCarModel() {
    if (!gltfLoader) return;

    gltfLoader.load(
        'car1.glb',
        (gltf) => {
            carMesh = gltf.scene;
            carMesh.scale.set(2.0, 2.0, 2.0);  // 再放大机身
            carMesh.rotation.y = Math.PI;
            carMesh.position.y = -0.5;
            carMesh.traverse((node) => { if (node.isMesh) node.castShadow = true; });
            scene.add(carMesh);
            carModelLoaded = true;
            checkGameReady();
        },
        undefined,
        () => {
            carModelLoaded = true;
            checkGameReady();
        }
    );
}

function loadTireModel() {
    if (!gltfLoader) return;

    gltfLoader.load(
        'tire1.glb',
        (gltf) => {
            tireMeshPrototype = gltf.scene;
            tireMeshPrototype.scale.set(1.0, 1.0, 1.0); // 增大轮胎
            tireMeshPrototype.rotation.x = Math.PI / 2;
            tireMeshPrototype.traverse((node) => { if (node.isMesh) node.castShadow = true; });
            tireModelLoaded = true;
            checkGameReady();
        },
        undefined,
        () => {
            tireModelLoaded = true;
            checkGameReady();
        }
    );
}

function loadCity() {
    const progressFill = document.getElementById('loading-progress-fill');
    const loadingStatus = document.getElementById('loading-status');

    if (!gltfLoader) return;

    gltfLoader.load(
        'city.glb',
        (gltf) => {
            const city = gltf.scene;
            city.traverse((node) => {
                if (node.isMesh) {
                    node.castShadow = true;
                    node.receiveShadow = true;
                }
            });
            city.scale.set(4, 4, 4);
            scene.add(city);
            cityLoaded = true;
            checkGameReady();
        },
        (xhr) => {
            if (xhr.total) {
                const percent = Math.floor(xhr.loaded / xhr.total * 100);
                progressFill.style.width = percent + '%';
                loadingStatus.innerText = `(${percent}%) Loading City Assets...`;
            }
        },
        () => {
            cityLoaded = true;
            checkGameReady();
        }
    );
}

// ============== THREE / CANNON 基础 ==============
function initThree() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87CEEB);

    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setPixelRatio(window.devicePixelRatio || 1);
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.BasicShadowMap;
    document.body.appendChild(renderer.domElement);
}

function initCannon() {
    world = new CANNON.World();
    world.gravity.set(0, -9.82, 0);
    world.broadphase = new CANNON.SAPBroadphase(world);
    world.allowSleep = true;

    const defaultMaterial = new CANNON.Material('default');
    const contactMaterial = new CANNON.ContactMaterial(
        defaultMaterial,
        defaultMaterial,
        { friction: 0.6, restitution: 0.0 }
    );
    world.defaultContactMaterial = contactMaterial;
    world.addContactMaterial(contactMaterial);
}

function initGround() {
    const groundShape = new CANNON.Plane();
    const groundBody = new CANNON.Body({
        mass: 0,
        material: world.defaultContactMaterial.material
    });
    groundBody.addShape(groundShape);
    groundBody.quaternion.setFromEuler(-Math.PI / 2, 0, 0);
    world.addBody(groundBody);

    const groundGeo = new THREE.PlaneGeometry(500, 500, 10, 10);
    const groundMat = new THREE.MeshPhongMaterial({ color: 0x444444 });
    const groundMesh = new THREE.Mesh(groundGeo, groundMat);
    groundMesh.rotation.x = -Math.PI / 2;
    groundMesh.position.y = -0.05;
    groundMesh.receiveShadow = true;
    scene.add(groundMesh);
}

function initCameraAndLights() {
    cameraChase = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
    cameraCockpit = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 1000);
    activeCamera = cameraChase;

    const hemiLight = new THREE.HemisphereLight(0xffffff, 0x3b4c5a, 0.8);
    scene.add(hemiLight);

    const dirLight = new THREE.DirectionalLight(0xfff0dd, 1.0);
    dirLight.position.set(50, 100, 50);
    dirLight.castShadow = true;
    dirLight.shadow.mapSize.width = 4096;
    dirLight.shadow.mapSize.height = 4096;
    dirLight.shadow.camera.near = 0.5;
    dirLight.shadow.camera.far = 500;
    dirLight.shadow.camera.left = -100;
    dirLight.shadow.camera.right = 100;
    dirLight.shadow.camera.top = 100;
    dirLight.shadow.camera.bottom = -100;
    scene.add(dirLight);
}

// ============== 车辆物理 ==============
function initVehicle() {
    const chassisShape = new CANNON.Box(new CANNON.Vec3(1, 0.5, 2));
    // 出生点：城市内偏右 ~1km（假设城市中心在 0,0）
    chassisBody = new CANNON.Body({
        mass: 1500,
        shape: chassisShape,
        position: new CANNON.Vec3(1000, 3.0, 200)
    });
    chassisBody.angularDamping = 0.3;
    chassisBody.linearDamping = 0.05;
    world.addBody(chassisBody);

    vehicle = new CANNON.RaycastVehicle({
        chassisBody: chassisBody,
        indexRightAxis: 0,
        indexUpAxis: 1,
        indexForwardAxis: 2
    });

    const axleWidth = 1.0;
    const wheelBase = 1.5;

    function makeWheelOptions(x, y, z) {
        return {
            radius: 0.5,
            directionLocal: new CANNON.Vec3(0, -1, 0),
            suspensionStiffness: 50,
            suspensionRestLength: 0.3,
            frictionSlip: 2.0,
            dampingRelaxation: 1.5,
            dampingCompression: 2.5,
            maxSuspensionForce: 100000,
            rollInfluence: 0.3,
            maxSuspensionTravel: 0.3,
            customSlidingRotationalSpeed: -30,
            useCustomSlidingRotationalSpeed: true,
            axleLocal: new CANNON.Vec3(1, 0, 0),
            chassisConnectionPointLocal: new CANNON.Vec3(x, y, z)
        };
    }

    vehicle.addWheel(makeWheelOptions(-axleWidth, 0, wheelBase));
    vehicle.addWheel(makeWheelOptions( axleWidth, 0, wheelBase));
    vehicle.addWheel(makeWheelOptions(-axleWidth, 0, -wheelBase));
    vehicle.addWheel(makeWheelOptions( axleWidth, 0, -wheelBase));

    vehicle.addToWorld(world);

    wheelMeshes = [];
    if (tireMeshPrototype) {
        for (let i = 0; i < vehicle.wheelInfos.length; i++) {
            const wheelMesh = tireMeshPrototype.clone();
            wheelMeshes.push(wheelMesh);
        }
    }
}

// ============== 输入 ==============
window.addEventListener('keydown', (event) => {
    switch (event.key.toLowerCase()) {
        case 'w': inputState.keyW = true; break;
        case 's': inputState.keyS = true; break;
        case 'a': inputState.keyA = true; break;
        case 'd': inputState.keyD = true; break;
        case ' ':
            inputState.keySpace = true;
            event.preventDefault();
            break;
        case 'v':
            toggleCamera();
            break;
    }
});

window.addEventListener('keyup', (event) => {
    switch (event.key.toLowerCase()) {
        case 'w': inputState.keyW = false; break;
        case 's': inputState.keyS = false; break;
        case 'a': inputState.keyA = false; break;
        case 'd': inputState.keyD = false; break;
        case ' ': inputState.keySpace = false; break;
    }
});

function toggleCamera() {
    activeCamera = (activeCamera === cameraChase) ? cameraCockpit : cameraChase;
}

// ============== 控制逻辑（线性油门） ==============
function updateControls(dt) {
    if (!chassisBody) return;

    steeringValue = 0;
    let brake = 0;

    const v = chassisBody.velocity;
    const currentSpeed = v.length() * 3.6;
    const chassisQuaternion = new THREE.Quaternion(
        chassisBody.quaternion.x,
        chassisBody.quaternion.y,
        chassisBody.quaternion.z,
        chassisBody.quaternion.w
    );
    const forwardVector = new THREE.Vector3(0, 0, 1).applyQuaternion(chassisQuaternion);
    const velocityVector = new THREE.Vector3(v.x, v.y, v.z);
    const isMovingForward = velocityVector.dot(forwardVector) > 0.5;
    const isMovingBackward = velocityVector.dot(forwardVector) < -0.5;

    // 转向
    if (inputState.keyA)      steeringValue = maxSteerVal;
    else if (inputState.keyD) steeringValue = -maxSteerVal;
    else                      steeringValue = 0;

    // 目标油门
    if (inputState.keyW && !inputState.keyS) {
        targetThrottle = 1;
        gearEl.textContent = 'D';
    } else if (inputState.keyS && !inputState.keyW) {
        targetThrottle = -0.5;
        gearEl.textContent = 'R';
    } else {
        targetThrottle = 0;
    }

    // 线性插值油门
    if (currentThrottle < targetThrottle) {
        currentThrottle = Math.min(currentThrottle + throttleStep * dt, targetThrottle);
    } else if (currentThrottle > targetThrottle) {
        currentThrottle = Math.max(currentThrottle - throttleStep * dt, targetThrottle);
    }

    engineForce = -maxEngineForce * currentThrottle;

    // 防止前进时直接倒车，给刹车
    if (inputState.keyW && isMovingBackward) {
        brake = maxEngineForce * 0.5;
        engineForce = 0;
    }
    if (inputState.keyS && isMovingForward) {
        brake = maxEngineForce * 0.5;
        engineForce = 0;
    }

    // 自动 P / N 档
    if (!inputState.keyW && !inputState.keyS && !inputState.keySpace) {
        if (currentSpeed < 1) gearEl.textContent = 'P';
        else                  gearEl.textContent = 'N';
    }

    // 前轮转向
    vehicle.setSteeringValue(steeringValue, 0);
    vehicle.setSteeringValue(steeringValue, 1);

    // 后轮驱动
    vehicle.applyEngineForce(engineForce, 2);
    vehicle.applyEngineForce(engineForce, 3);

    // 手刹
    let finalBrakeFL = brake;
    let finalBrakeFR = brake;
    let finalBrakeRL = brake;
    let finalBrakeRR = brake;

    if (inputState.keySpace) {
        const handbrakeStrength = maxEngineForce * 0.8;
        finalBrakeRL = handbrakeStrength;
        finalBrakeRR = handbrakeStrength;
        gearEl.textContent = 'E';
    }

    vehicle.setBrake(finalBrakeFL, 0);
    vehicle.setBrake(finalBrakeFR, 1);
    vehicle.setBrake(finalBrakeRL, 2);
    vehicle.setBrake(finalBrakeRR, 3);

    if (finalBrakeFL === 0 && finalBrakeRL === 0 && !inputState.keySpace) {
        vehicle.setBrake(0, 0);
        vehicle.setBrake(0, 1);
        vehicle.setBrake(0, 2);
        vehicle.setBrake(0, 3);
    }
}

// ============== 视觉更新 ==============
function updateCamera() {
    if (!chassisBody) return;
    const chassisPos = chassisBody.position;
    const q = chassisBody.quaternion;

    if (activeCamera === cameraChase) {
        const offset = new THREE.Vector3(0, 4, -9);
        offset.applyQuaternion(q);
        offset.add(chassisPos);
        cameraChase.position.lerp(offset, 0.1);
        cameraChase.lookAt(chassisPos.x, chassisPos.y + 1, chassisPos.z);
    } else {
        const offset = new THREE.Vector3(0, 1.0, 1.6);
        offset.applyQuaternion(q);
        offset.add(chassisPos);
        cameraCockpit.position.copy(offset);
        cameraCockpit.quaternion.copy(q);
        const rotation180 = new THREE.Quaternion().setFromAxisAngle(
            new THREE.Vector3(0, 1, 0), Math.PI
        );
        cameraCockpit.quaternion.multiply(rotation180);
    }
}

function updateWheelMeshes() {
    if (!vehicle) return;
    for (let i = 0; i < vehicle.wheelInfos.length; i++) {
        vehicle.updateWheelTransform(i);
        const t = vehicle.wheelInfos[i].worldTransform;
        if (wheelMeshes[i]) {
            wheelMeshes[i].position.copy(t.position);
            wheelMeshes[i].quaternion.copy(t.quaternion);
        }
    }
}

function updateCarMesh() {
    if (chassisBody && carMesh) {
        carMesh.position.copy(chassisBody.position);
        carMesh.quaternion.copy(chassisBody.quaternion);
    }
}

function updateHUD() {
    if (!chassisBody) return;
    const v = chassisBody.velocity;
    const speed = v.length() * 3.6;
    speedEl.textContent = speed.toFixed(0);
    altitudeEl.textContent = chassisBody.position.y.toFixed(0);

    const forward = new THREE.Vector3(0, 0, 1);
    forward.applyQuaternion(new THREE.Quaternion(
        chassisBody.quaternion.x,
        chassisBody.quaternion.y,
        chassisBody.quaternion.z,
        chassisBody.quaternion.w
    ));
    const heading = Math.atan2(forward.x, forward.z) * 180 / Math.PI;
    let h = (heading + 360) % 360;
    headingEl.textContent = h.toFixed(0).padStart(3, '0');

    const rpm = Math.min(75, Math.floor(speed * 2.0));
    rpmEl.textContent = rpm;

    const steerDegrees = (steeringValue / maxSteerVal * 30).toFixed(0);
    steerEl.textContent = steerDegrees + '°';

    let throttlePercent = Math.abs(currentThrottle * 100).toFixed(0);
    throttleEl.textContent = throttlePercent + '%';
}

// ============== 动画循环 ==============
function animate(time) {
    requestAnimationFrame(animate);
    if (!chassisBody || !world) return;

    const fixedTimeStep = 1 / 60;
    const maxSubSteps = 1;

    let dt = fixedTimeStep;
    if (lastTime !== undefined) {
        dt = (time - lastTime) / 1000;
    }
    lastTime = time;

    world.step(fixedTimeStep, dt, maxSubSteps);

    updateControls(dt);
    updateWheelMeshes();
    updateCarMesh();
    updateCamera();
    updateHUD();
    renderer.render(scene, activeCamera);
}

// ============== 自适应窗口 / 初始化 ==============
window.addEventListener('resize', () => {
    if (renderer && cameraChase && cameraCockpit) {
        renderer.setSize(window.innerWidth, window.innerHeight);
        const aspect = window.innerWidth / window.innerHeight;
        cameraChase.aspect = aspect;
        cameraChase.updateProjectionMatrix();
        cameraCockpit.aspect = aspect;
        cameraCockpit.updateProjectionMatrix();
    }
    if (splashRenderer && splashCamera) {
        const container = document.getElementById('splash-three-container');
        const width = container.clientWidth;
        const height = container.clientHeight;
        splashRenderer.setSize(width, height);
        splashCamera.aspect = width / height;
        splashCamera.updateProjectionMatrix();
    }
});

document.addEventListener('DOMContentLoaded', () => {
    initLoaders();
    initSplashThree();
    loadSplashCarModel();
});
</script>
</body>
</html>
