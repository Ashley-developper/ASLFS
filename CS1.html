<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OPEN WORLD HYPER DRIVE - UPDATED</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* =========================================================================
         * CORE STYLES
         * ========================================================================= */
        body { 
            margin: 0; overflow: hidden; background: #000; 
            font-family: 'Rajdhani', sans-serif; color: #E0FFFF; user-select: none; 
        }
        
        /* =========================================================================
         * HUD (IN-GAME)
         * ========================================================================= */
        #hud-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column; justify-content: space-between;
            padding: 20px; box-sizing: border-box; z-index: 10;
        }
        .hud-top-left { display: flex; gap: 15px; flex-wrap: wrap; }
        .hud-top-right { position: absolute; top: 20px; right: 20px; text-align: right;}
        
        .instrument {
            background: rgba(0, 15, 30, 0.8);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-left: 4px solid #00FFFF;
            padding: 10px 15px; min-width: 100px;
            clip-path: polygon(0 0, 100% 0, 100% 85%, 90% 100%, 0 100%);
        }
        .label { font-family: 'Orbitron'; font-size: 10px; color: #00FFFF; letter-spacing: 1px; display:block; }
        .value { font-family: 'Orbitron'; font-size: 28px; font-weight: 900; color: #FFF; }
        .unit { font-size: 12px; color: #888; margin-left: 4px; }

        /* Specific Colors */
        .spd-color { border-left-color: #00FFFF; }
        .rpm-color { border-left-color: #FF00FF; }
        .gear-color { border-left-color: #FFD700; }

        #hud-coin { 
            border-left: 4px solid #FFD700; background: rgba(40, 30, 0, 0.8); 
            display: inline-block; padding-right: 30px;
        }
        #coin-count { color: #FFD700; }

        /* Delivery HUD */
        #delivery-hud {
            position: absolute; top: 150px; left: 20px;
            background: rgba(0, 30, 0, 0.85); border: 1px solid #00FF00; border-left: 4px solid #00FF00;
            padding: 15px; width: 220px; display: none;
        }
        .mission-title { font-family: 'Orbitron'; color: #00FF00; font-weight: bold; font-size: 12px; margin-bottom: 5px; border-bottom: 1px dashed #00FF00; }
        
        /* Notifications (Drift/Reward) */
        #notification-area {
            position: absolute; top: 20%; left: 50%; transform: translateX(-50%);
            text-align: center; pointer-events: none;
        }
        .notify-msg {
            font-family: 'Orbitron'; font-size: 24px; font-weight: 900;
            color: #FFD700; text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
            margin-bottom: 10px; opacity: 0; transition: opacity 0.5s;
            animation: popUp 2s forwards;
        }
        @keyframes popUp {
            0% { opacity: 0; transform: translateY(20px); }
            20% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }

        #control-hints {
            position: absolute; bottom: 20px; left: 20px;
            background: rgba(0,0,0,0.7); border-left: 3px solid #FFF;
            padding: 15px; color: #AAA; font-size: 12px;
        }

        /* =========================================================================
         * SPLASH & MENUS
         * ========================================================================= */
        #splash {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #1a1a1a 0%, #000000 100%);
            z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        
        .splash-header h1 {
            font-family: 'Orbitron'; font-size: 72px; margin: 0;
            background: linear-gradient(to right, #00FFFF, #FF00FF);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(0,255,255,0.5);
            text-transform: uppercase; letter-spacing: 5px;
        }
        
        .main-menu-btns {
            margin-top: 50px; display: flex; flex-direction: column; gap: 15px; width: 300px;
        }
        .menu-btn {
            background: transparent; border: 1px solid rgba(255,255,255,0.2);
            color: #FFF; font-family: 'Orbitron'; font-size: 18px; padding: 15px;
            cursor: pointer; transition: 0.2s; text-align: center;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
        }
        .menu-btn:hover { background: #00FFFF; color: #000; box-shadow: 0 0 15px #00FFFF; }
        .btn-play { background: #00FFFF; color: #000; font-weight: 900; font-size: 22px; border: none; }
        .btn-play:hover { background: #FFF; transform: scale(1.05); }

        /* Menu Pages */
        .menu-page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 1000; display: none;
            flex-direction: column; align-items: center; justify-content: flex-start;
            padding-top: 80px;
        }
        .menu-page h2 { font-family: 'Orbitron'; color: #FF00FF; font-size: 36px; margin-bottom: 30px; }
        .close-btn {
            position: absolute; top: 30px; right: 40px;
            background: #FF0000; color: #FFF; border: none; padding: 10px 20px;
            font-family: 'Orbitron'; cursor: pointer; font-weight: bold;
        }

        /* SHOP GRID */
        .shop-grid { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; max-width: 800px; }
        .shop-item {
            background: rgba(255,255,255,0.05); border: 1px solid #333; padding: 20px;
            width: 200px; text-align: center; transition: 0.2s;
        }
        .shop-item:hover { border-color: #00FFFF; background: rgba(0,255,255,0.1); }
        .shop-item h3 { color: #00FFFF; font-family: 'Orbitron'; margin: 0 0 10px 0; font-size: 16px; }
        .shop-item p { font-size: 14px; color: #BBB; height: 40px;}
        .shop-price { color: #FFD700; font-weight: bold; font-size: 18px; margin: 10px 0; }
        .buy-btn {
            background: #222; color: #FFF; border: 1px solid #555; padding: 8px 15px;
            font-family: 'Orbitron'; cursor: pointer; width: 100%;
        }
        .buy-btn.owned { background: #333; color: #00FF00; border: 1px solid #00FF00; cursor: default; }
        .buy-btn.can-afford:hover { background: #FFD700; color: #000; }

        /* Loading */
        #loading-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 2000; display: flex; flex-direction: column;
            align-items: center; justify-content: center; color: #00FFFF;
        }
        #loading-bar { width: 300px; height: 4px; background: #333; margin-top: 20px; }
        #loading-fill { width: 0%; height: 100%; background: #00FFFF; transition: width 0.2s; }
        
        .daily-reward-popup {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9); border: 2px solid #FFD700; padding: 40px;
            text-align: center; z-index: 1500; display: none;
            box-shadow: 0 0 50px rgba(255,215,0,0.3);
        }
    </style>
</head>
<body>

    <div id="loading-screen">
        <h2 style="font-family:'Orbitron'">SYSTEM INITIALIZING</h2>
        <div id="loading-bar"><div id="loading-fill"></div></div>
        <p id="loading-text" style="font-size:12px; margin-top:10px;">Loading Assets...</p>
    </div>

    <div id="daily-reward" class="daily-reward-popup">
        <h2 style="color:#FFD700; font-family:'Orbitron'">DAILY LOGIN BONUS!</h2>
        <p style="font-size:20px;">WELCOME BACK, DRIVER.</p>
        <p style="font-size:40px; color:#FFD700; font-weight:bold;">+500 CREDITS</p>
        <button class="menu-btn" onclick="claimDailyReward()">COLLECT</button>
    </div>

    <div id="splash">
        <div class="splash-header">
            <h1>OPEN WORLD<br>HYPER DRIVE</h1>
            <p style="color:#888; letter-spacing:4px; font-size:14px;">IMPROVED EDITION v2.0</p>
        </div>
        
        <div style="position:absolute; top:20px; right:20px; text-align:right;">
            <div style="font-family:'Orbitron'; color:#FFD700; font-size:12px;">TOTAL CREDITS</div>
            <div id="menu-coin-display" style="font-family:'Orbitron'; color:#FFF; font-size:32px;">0</div>
        </div>

        <div class="main-menu-btns">
            <button class="menu-btn btn-play" onclick="startGame()">ENTER WORLD</button>
            <button class="menu-btn" onclick="openShop()">GARAGE / SHOP</button>
            <button class="menu-btn" onclick="resetProgress()">RESET DATA</button>
        </div>
        
        <div style="position:absolute; bottom:20px; color:#555; font-size:10px;">
            ASSETS COPYRIGHT Â© RESPECTIVE OWNERS. CODE OPTIMIZED FOR CRAZYGAMES.
        </div>
    </div>

    <div id="shop-page" class="menu-page">
        <button class="close-btn" onclick="closeShop()">CLOSE</button>
        <h2>PERFORMANCE & VISUALS</h2>
        <div style="color:#FFD700; font-family:'Orbitron'; font-size:24px; margin-bottom:20px;">
            CREDITS: <span id="shop-coin-display">0</span>
        </div>
        
        <div class="shop-grid">
            <div class="shop-item">
                <h3>ENGINE STAGE 2</h3>
                <p>Increase top speed and acceleration.</p>
                <div class="shop-price">500 C</div>
                <button id="btn-upgrade-engine" class="buy-btn" onclick="buyEngineUpgrade()">BUY</button>
            </div>
            
            <div class="shop-item">
                <h3>NEON BLUE</h3>
                <div style="width:100%; height:20px; background:#00FFFF; margin:5px 0;"></div>
                <div class="shop-price">200 C</div>
                <button id="btn-color-cyan" class="buy-btn" onclick="buyColor('cyan', 200)">BUY</button>
            </div>
            
            <div class="shop-item">
                <h3>HOT PINK</h3>
                <div style="width:100%; height:20px; background:#FF00FF; margin:5px 0;"></div>
                <div class="shop-price">200 C</div>
                <button id="btn-color-magenta" class="buy-btn" onclick="buyColor('magenta', 200)">BUY</button>
            </div>

            <div class="shop-item">
                <h3>LIME GREEN</h3>
                <div style="width:100%; height:20px; background:#00FF00; margin:5px 0;"></div>
                <div class="shop-price">300 C</div>
                <button id="btn-color-lime" class="buy-btn" onclick="buyColor('lime', 300)">BUY</button>
            </div>
        </div>
        <p id="shop-msg" style="color:#FF0000; height:20px; margin-top:20px;"></p>
    </div>

    <div id="hud-layer" style="display:none;">
        <div class="hud-top-left">
            <div class="instrument spd-color"><span class="label">SPEED</span><span class="value" id="hud-spd">0</span></div>
            <div class="instrument rpm-color"><span class="label">RPM</span><span class="value" id="hud-rpm">0</span></div>
            <div class="instrument gear-color"><span class="label">GEAR</span><span class="value" id="hud-gear">N</span></div>
        </div>
        
        <div class="hud-top-right">
            <div class="instrument" id="hud-coin">
                <span class="label">CREDITS</span><span class="value" id="coin-count">0</span>
            </div>
        </div>

        <div id="notification-area"></div>

        <div id="delivery-hud">
            <div class="mission-title" id="mission-text">NO MISSION</div>
            <div style="color:#FFF;">DIST: <span id="dist-val">0</span>m</div>
            <div style="color:#FFD700;">TIME: <span id="time-val">--:--</span></div>
        </div>

        <div id="control-hints">
            <div style="color:#00FFFF; font-weight:bold; margin-bottom:5px;">CONTROLS</div>
            WASD / ARROWS : Drive<br>
            SPACE : Handbrake / Drift<br>
            SHIFT : Nitro (Cost Fuel)<br>
            V : Camera View<br>
            R : Respawn<br>
            P : Start Delivery Mission
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/DRACOLoader.js"></script>

    <script>
    // =========================================================================
    // ** 1. GAME DATA & SAVE SYSTEM (CRITICAL FOR RETENTION) **
    // =========================================================================
    const SAVE_KEY = 'OWHD_SAVE_V2';
    
    let playerData = {
        coins: 0,
        engineLevel: 1, // 1 = normal, 2 = sport
        colorsOwned: ['default'],
        currentColor: 'default', // 'default', 'cyan', 'magenta', 'lime'
        lastLogin: 0
    };

    function loadData() {
        const saved = localStorage.getItem(SAVE_KEY);
        if (saved) {
            try {
                playerData = JSON.parse(saved);
            } catch(e) { console.error('Save Corrupt'); }
        }
        updateUI();
    }

    function saveData() {
        localStorage.setItem(SAVE_KEY, JSON.stringify(playerData));
        updateUI();
    }

    function updateUI() {
        document.getElementById('menu-coin-display').innerText = playerData.coins;
        document.getElementById('shop-coin-display').innerText = playerData.coins;
        document.getElementById('coin-count').innerText = playerData.coins;
        
        // Update Shop Buttons State
        updateShopButton('btn-upgrade-engine', playerData.engineLevel >= 2);
        updateShopButton('btn-color-cyan', playerData.colorsOwned.includes('cyan'), playerData.currentColor === 'cyan');
        updateShopButton('btn-color-magenta', playerData.colorsOwned.includes('magenta'), playerData.currentColor === 'magenta');
        updateShopButton('btn-color-lime', playerData.colorsOwned.includes('lime'), playerData.currentColor === 'lime');
    }

    function updateShopButton(id, isOwned, isEquipped) {
        const btn = document.getElementById(id);
        if(!btn) return;
        if (isEquipped) {
            btn.innerText = "EQUIPPED";
            btn.className = "buy-btn owned";
            btn.onclick = null;
        } else if (isOwned) {
            btn.innerText = "EQUIP";
            btn.className = "buy-btn can-afford"; // Re-use style for equip
            btn.onclick = function() { equipItem(id); };
        }
    }

    function resetProgress() {
        if(confirm("Reset all progress and coins?")) {
            localStorage.removeItem(SAVE_KEY);
            location.reload();
        }
    }

    // =========================================================================
    // ** 2. SHOP LOGIC **
    // =========================================================================
    function openShop() { document.getElementById('shop-page').style.display = 'flex'; updateUI(); }
    function closeShop() { document.getElementById('shop-page').style.display = 'none'; }

    function buyEngineUpgrade() {
        if (playerData.engineLevel >= 2) return;
        if (playerData.coins >= 500) {
            playerData.coins -= 500;
            playerData.engineLevel = 2;
            saveData();
            showShopMsg("ENGINE UPGRADED!", "#00FF00");
        } else {
            showShopMsg("NOT ENOUGH CREDITS", "#FF0000");
        }
    }

    function buyColor(color, cost) {
        if (playerData.colorsOwned.includes(color)) {
            equipColor(color);
            return;
        }
        if (playerData.coins >= cost) {
            playerData.coins -= cost;
            playerData.colorsOwned.push(color);
            equipColor(color);
            saveData();
            showShopMsg("COLOR PURCHASED!", "#00FF00");
        } else {
            showShopMsg("NOT ENOUGH CREDITS", "#FF0000");
        }
    }

    function equipItem(btnId) {
        if(btnId.includes('color-cyan')) equipColor('cyan');
        if(btnId.includes('color-magenta')) equipColor('magenta');
        if(btnId.includes('color-lime')) equipColor('lime');
    }

    function equipColor(color) {
        playerData.currentColor = color;
        saveData();
        updateUI();
        if(carMesh) applyCarColor(); // Apply immediately if mesh loaded
    }

    function showShopMsg(txt, color) {
        const el = document.getElementById('shop-msg');
        el.innerText = txt; el.style.color = color;
        setTimeout(() => el.innerText = "", 2000);
    }

    function claimDailyReward() {
        playerData.coins += 500;
        playerData.lastLogin = Date.now();
        saveData();
        document.getElementById('daily-reward').style.display = 'none';
        
        // Visual flair
        showNotification("+500 DAILY BONUS!");
    }

    function checkDailyReward() {
        const now = Date.now();
        const oneDay = 24 * 60 * 60 * 1000;
        // If first time or more than 24 hours
        if (playerData.lastLogin === 0 || (now - playerData.lastLogin) > oneDay) {
            document.getElementById('daily-reward').style.display = 'block';
        }
    }

    // =========================================================================
    // ** 3. GAME ENGINE (THREE.JS + CANNON) **
    // =========================================================================
    let scene, camera, renderer, world, vehicle, chassisBody;
    let isGameActive = false;
    let carMesh, coinMeshProto;
    let coins = [];
    
    // Physics Config
    let maxEngineForce = 1500; // Will be scaled by upgrades
    let maxSteerVal = 0.6;
    let brakeForce = 50;

    const input = { w:0, a:0, s:0, d:0, space:0, shift:0 };

    function init() {
        loadData();
        checkDailyReward();

        // Scene
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB);
        scene.fog = new THREE.Fog(0x87CEEB, 200, 1000);

        // Camera
        camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 2000);
        camera.position.set(0, 5, -10);

        // Renderer
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5)); // Optim
        document.body.appendChild(renderer.domElement);

        // Lights
        const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 0.8);
        scene.add(hemi);
        const dir = new THREE.DirectionalLight(0xffffff, 0.8);
        dir.position.set(100, 200, 100);
        dir.castShadow = true;
        dir.shadow.camera.top = 200; dir.shadow.camera.bottom = -200;
        dir.shadow.camera.left = -200; dir.shadow.camera.right = 200;
        dir.shadow.mapSize.width = 2048; dir.shadow.mapSize.height = 2048;
        scene.add(dir);

        // Physics World
        world = new CANNON.World();
        world.gravity.set(0, -9.82, 0);
        world.broadphase = new CANNON.SAPBroadphase(world);

        // Ground
        const groundMat = new THREE.MeshStandardMaterial({ color: 0x222222, roughness: 0.8 });
        const groundGeo = new THREE.PlaneGeometry(5000, 5000);
        const groundMesh = new THREE.Mesh(groundGeo, groundMat);
        groundMesh.rotation.x = -Math.PI/2;
        groundMesh.receiveShadow = true;
        scene.add(groundMesh);

        const groundPhys = new CANNON.Body({ mass: 0, shape: new CANNON.Plane() });
        groundPhys.quaternion.setFromEuler(-Math.PI/2, 0, 0);
        world.addBody(groundPhys);

        // Load Assets
        loadAssets();

        // Listeners
        window.addEventListener('resize', onResize);
        window.addEventListener('keydown', e => handleKey(e, true));
        window.addEventListener('keyup', e => handleKey(e, false));

        // Start Loop
        requestAnimationFrame(animate);
    }

    function loadAssets() {
        const loader = new THREE.GLTFLoader();
        const draco = new THREE.DRACOLoader();
        draco.setDecoderPath('https://www.gstatic.com/draco/v1/decoders/');
        loader.setDRACOLoader(draco);

        const manager = new THREE.LoadingManager();
        manager.onProgress = (url, loaded, total) => {
            const pct = Math.floor((loaded/total)*100);
            document.getElementById('loading-fill').style.width = pct + "%";
            document.getElementById('loading-text').innerText = "Loading: " + pct + "%";
        };
        manager.onLoad = () => {
            document.getElementById('loading-screen').style.display = 'none';
        };

        const safeLoader = new THREE.GLTFLoader(manager);
        safeLoader.setDRACOLoader(draco);

        // 1. CAR (Assume car1.glb exists or use fallback)
        safeLoader.load('car1.glb', (gltf) => {
            carMesh = gltf.scene;
            carMesh.scale.set(100,100,100); // Original scale preserved
            carMesh.rotation.y = Math.PI;
            scene.add(carMesh);
            initPhysicsCar();
            applyCarColor(); // Apply color on load
        }, undefined, (err) => {
            console.log("Using Box Fallback for Car");
            const box = new THREE.Mesh(new THREE.BoxGeometry(2,1,4), new THREE.MeshNormalMaterial());
            carMesh = box;
            scene.add(carMesh);
            initPhysicsCar();
        });

        // 2. CITY (Using external fallback if local fails, but PRIORITIZING local)
        // ** INSTRUCTION: Change this to './city.glb' for production **
        const cityUrl = 'https://ashley-developper.github.io/ASLFS/city.glb'; 
        safeLoader.load(cityUrl, (gltf) => {
            const city = gltf.scene;
            city.scale.set(4,4,4);
            scene.add(city);
            // Create simple physics for city (optimization: just ground plane for now to save FPS)
        });

        // 3. COIN
        safeLoader.load('gold_coin.glb', (gltf) => {
            coinMeshProto = gltf.scene;
            spawnCoins();
        }, undefined, () => {
            // Fallback coin
            coinMeshProto = new THREE.Mesh(new THREE.CylinderGeometry(0.5,0.5,0.1,16), new THREE.MeshStandardMaterial({color:0xFFD700}));
            coinMeshProto.rotation.x = Math.PI/2;
            spawnCoins();
        });
    }

    function initPhysicsCar() {
        const chassisShape = new CANNON.Box(new CANNON.Vec3(1, 0.5, 2));
        chassisBody = new CANNON.Body({ mass: 1500 });
        chassisBody.addShape(chassisShape, new CANNON.Vec3(0,0.5,0)); // Offset center of mass
        chassisBody.position.set(0, 5, 0);
        chassisBody.angularDamping = 0.5;

        vehicle = new CANNON.RaycastVehicle({
            chassisBody: chassisBody,
            indexRightAxis: 0, indexUpAxis: 1, indexForwardAxis: 2
        });

        const opts = {
            radius: 0.5, directionLocal: new CANNON.Vec3(0, -1, 0),
            suspensionStiffness: 30, suspensionRestLength: 0.3,
            frictionSlip: 2.0, dampingRelaxation: 2.3, dampingCompression: 4.4,
            maxSuspensionForce: 100000, rollInfluence: 0.01,
            axleLocal: new CANNON.Vec3(1, 0, 0),
            chassisConnectionPointLocal: new CANNON.Vec3(1, 0, 1),
            maxSuspensionTravel: 0.3, customSlidingRotationalSpeed: -30,
            useCustomSlidingRotationalSpeed: true
        };

        vehicle.addWheel({...opts, chassisConnectionPointLocal: new CANNON.Vec3(-1, 0, 1.5)});
        vehicle.addWheel({...opts, chassisConnectionPointLocal: new CANNON.Vec3( 1, 0, 1.5)});
        vehicle.addWheel({...opts, chassisConnectionPointLocal: new CANNON.Vec3(-1, 0, -1.5)});
        vehicle.addWheel({...opts, chassisConnectionPointLocal: new CANNON.Vec3( 1, 0, -1.5)});

        vehicle.addToWorld(world);
        
        // Add simple wheel visuals
        const wheelGeo = new THREE.CylinderGeometry(0.5, 0.5, 0.3, 24);
        wheelGeo.rotateZ(Math.PI/2);
        const wheelMat = new THREE.MeshStandardMaterial({color:0x111111});
        
        vehicle.wheelInfos.forEach((w) => {
            const mesh = new THREE.Mesh(wheelGeo, wheelMat);
            scene.add(mesh);
            w.mesh = mesh; // Link physics wheel to visual mesh
        });
    }

    // =========================================================================
    // ** 4. GAMEPLAY MECHANICS **
    // =========================================================================

    function applyCarColor() {
        if(!carMesh) return;
        let hex = 0xFFFFFF; // default
        if (playerData.currentColor === 'cyan') hex = 0x00FFFF;
        if (playerData.currentColor === 'magenta') hex = 0xFF00FF;
        if (playerData.currentColor === 'lime') hex = 0x00FF00;

        // Traverse mesh to find the body paint material (Usually standard material)
        carMesh.traverse((o) => {
            if (o.isMesh) {
                // Heuristic: The largest mesh is usually the body, or specific names
                // For this generic code, we clone material and tint it
                o.material = o.material.clone();
                o.material.color.setHex(hex);
            }
        });
    }

    function spawnCoins() {
        for(let i=0; i<30; i++) {
            const x = (Math.random()-0.5)*1000;
            const z = (Math.random()-0.5)*1000;
            
            const mesh = coinMeshProto.clone();
            mesh.position.set(x, 1, z);
            mesh.scale.set(2,2,2);
            scene.add(mesh);

            coins.push({ mesh: mesh, active: true, radius: 2 });
        }
    }

    function startGame() {
        document.getElementById('splash').style.display = 'none';
        document.getElementById('hud-layer').style.display = 'flex';
        isGameActive = true;
        
        // Reset Car
        chassisBody.position.set(0,2,0);
        chassisBody.velocity.set(0,0,0);
        chassisBody.angularVelocity.set(0,0,0);
        chassisBody.quaternion.set(0,0,0,1);
    }

    function handleKey(e, down) {
        if(!isGameActive) return;
        const k = e.key.toLowerCase();
        if(k==='w' || k==='arrowup') input.w = down;
        if(k==='s' || k==='arrowdown') input.s = down;
        if(k==='a' || k==='arrowleft') input.a = down;
        if(k==='d' || k==='arrowright') input.d = down;
        if(k===' ') input.space = down;
        if(k==='shift') input.shift = down;
        if(k==='r' && down) startGame();
        if(k==='p' && down) startMission();
    }

    // Drift Logic
    let driftScore = 0;
    function checkDrift() {
        if(!chassisBody) return;
        const speed = chassisBody.velocity.length();
        // If turning hard and moving fast
        if(Math.abs(vehicle.getSteeringValue(0)) > 0.4 && speed > 15) {
            driftScore++;
            if(driftScore > 60 && driftScore % 60 === 0) { // Every ~1 sec of drifting
                const bonus = 10;
                playerData.coins += bonus;
                saveData();
                showNotification("DRIFT BONUS! +" + bonus);
            }
        } else {
            driftScore = 0;
        }
    }

    function showNotification(text) {
        const area = document.getElementById('notification-area');
        const div = document.createElement('div');
        div.className = 'notify-msg';
        div.innerText = text;
        area.appendChild(div);
        setTimeout(() => div.remove(), 2000);
    }

    // =========================================================================
    // ** 5. DELIVERY MODE (Simplified for Stability) **
    // =========================================================================
    let mission = { active: false, dest: null, timer: 0 };
    const destPoints = [
        new CANNON.Vec3(200, 0, 200),
        new CANNON.Vec3(-200, 0, 200),
        new CANNON.Vec3(300, 0, -100)
    ];

    function startMission() {
        if(mission.active) return;
        const pt = destPoints[Math.floor(Math.random()*destPoints.length)];
        mission = {
            active: true,
            dest: pt,
            timer: 60 // 60 seconds
        };
        document.getElementById('delivery-hud').style.display = 'block';
        document.getElementById('mission-text').innerText = "DELIVER PACKAGE!";
    }

    function updateMission(dt) {
        if(!mission.active) return;
        mission.timer -= dt;
        
        const dist = chassisBody.position.distanceTo(mission.dest);
        document.getElementById('dist-val').innerText = Math.floor(dist);
        document.getElementById('time-val').innerText = Math.floor(mission.timer);

        if(dist < 10) {
            // Success
            playerData.coins += 200;
            saveData();
            showNotification("MISSION COMPLETE! +200");
            mission.active = false;
            document.getElementById('delivery-hud').style.display = 'none';
        }

        if(mission.timer <= 0) {
            showNotification("MISSION FAILED");
            mission.active = false;
            document.getElementById('delivery-hud').style.display = 'none';
        }
    }


    // =========================================================================
    // ** 6. MAIN LOOP **
    // =========================================================================
    const clock = new THREE.Clock();

    function animate() {
        requestAnimationFrame(animate);
        const dt = clock.getDelta();

        if (world) world.step(1/60);

        if (isGameActive && vehicle) {
            // Upgrade Logic: Stage 2 engine has 2x power
            const engineMult = (playerData.engineLevel === 2) ? 1.8 : 1.0;
            
            let force = 0;
            if (input.w) force = -maxEngineForce * engineMult;
            if (input.s) force = maxEngineForce * 0.5;
            
            vehicle.applyEngineForce(force, 2);
            vehicle.applyEngineForce(force, 3);

            let steer = 0;
            if (input.a) steer = maxSteerVal;
            if (input.d) steer = -maxSteerVal;
            vehicle.setSteeringValue(steer, 0);
            vehicle.setSteeringValue(steer, 1);

            let brake = input.space ? 100 : 0;
            vehicle.setBrake(brake, 0); vehicle.setBrake(brake, 1);
            vehicle.setBrake(brake, 2); vehicle.setBrake(brake, 3);

            // Sync Visuals
            if (carMesh) {
                carMesh.position.copy(chassisBody.position);
                carMesh.quaternion.copy(chassisBody.quaternion);
                carMesh.position.y -= 0.5; // Visual offset
            }
            
            // Sync Wheels
            for(let i=0; i<vehicle.wheelInfos.length; i++) {
                vehicle.updateWheelTransform(i);
                const t = vehicle.wheelInfos[i].worldTransform;
                if(vehicle.wheelInfos[i].mesh) {
                    vehicle.wheelInfos[i].mesh.position.copy(t.position);
                    vehicle.wheelInfos[i].mesh.quaternion.copy(t.quaternion);
                }
            }

            // Camera Chase
            const camOffset = new THREE.Vector3(0, 4, -8).applyQuaternion(chassisBody.quaternion).add(chassisBody.position);
            camera.position.lerp(camOffset, 0.1);
            camera.lookAt(chassisBody.position);

            // HUD
            const speed = (chassisBody.velocity.length() * 3.6).toFixed(0);
            document.getElementById('hud-spd').innerText = speed;
            document.getElementById('hud-rpm').innerText = Math.floor(speed * 30);

            // Coin Logic
            coins.forEach(c => {
                if(c.active) {
                    c.mesh.rotation.y += 0.05;
                    if(chassisBody.position.distanceTo(c.mesh.position) < 3) {
                        c.active = false;
                        c.mesh.visible = false;
                        playerData.coins += 10;
                        saveData();
                        showNotification("+10");
                    }
                }
            });

            checkDrift();
            updateMission(dt);
        }

        renderer.render(scene, camera);
    }

    // Start
    window.onload = init;

    function onResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    </script>
</body>
</html>
